#!/bin/bash

# SysArmor OpenTelemetry Collector 安装脚本
# 自动生成，收集器ID: {{.CollectorID}}
# 生成时间: {{.GeneratedAt}}

# 颜色定义
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly NC='\033[0m' # No Color

# 配置常量
readonly INSTALL_DIR="/opt/sysarmor"
readonly BINARY_NAME="otelcol-sysarmor"
readonly CONFIG_FILE="cfg.yaml"
readonly SERVICE_NAME="sysarmor-otelcol"
readonly MANAGER_URL="{{.ManagerURL}}"
readonly COLLECTOR_ID="{{.CollectorID}}"

# 日志函数
log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# 检查是否以 root 权限运行
check_root() {
    if [[ $EUID -ne 0 ]]; then
        log_error "此脚本需要 root 权限运行"
        log_info "请使用: sudo $0"
        exit 1
    fi
}

# 检查必要工具
check_dependencies() {
    local missing_deps=()
    
    for cmd in curl apt-get; do
        if ! command -v "$cmd" >/dev/null 2>&1; then
            missing_deps+=("$cmd")
        fi
    done
    
    if [[ ${#missing_deps[@]} -gt 0 ]]; then
        log_error "缺少必要工具: ${missing_deps[*]}"
        log_info "请先安装: sudo apt-get update && sudo apt-get install -y curl"
        exit 1
    fi
}

# 安装系统依赖
install_system_dependencies() {
    log_info "安装系统依赖..."
    
    # 更新软件包列表
    if ! apt-get update; then
        log_error "更新软件包列表失败"
        exit 1
    fi
    
    # 安装 cpulimit 和其他必要工具
    local packages=("cpulimit" "procps" "psmisc")
    for package in "${packages[@]}"; do
        log_info "安装 $package..."
        if ! apt-get install -y "$package"; then
            log_error "安装 $package 失败"
            exit 1
        fi
    done
    
    log_info "系统依赖安装完成"
}

# 检查现有安装
check_existing_installation() {
    # 检查是否已有 otelcol 进程在运行
    if pgrep -f "$BINARY_NAME" >/dev/null; then
        local pid=$(pgrep -f "$BINARY_NAME")
        log_warn "发现已运行的 OpenTelemetry Collector 进程 (PID: $pid)"
        read -p "是否要停止现有进程并重新安装? (y/N): " -r
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            log_info "停止现有进程..."
            pkill -f "$BINARY_NAME" || true
            sleep 2
        else
            log_info "安装已取消"
            exit 0
        fi
    fi
    
    # 检查安装目录
    if [[ -d "$INSTALL_DIR" ]]; then
        log_warn "发现已存在的安装目录: $INSTALL_DIR"
        read -p "是否要覆盖现有安装? (y/N): " -r
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            log_info "安装已取消"
            exit 0
        fi
    fi
}

# 创建安装目录
create_install_directory() {
    log_info "创建安装目录: $INSTALL_DIR"
    mkdir -p "$INSTALL_DIR"
    if [[ ! -d "$INSTALL_DIR" ]]; then
        log_error "创建安装目录失败"
        exit 1
    fi
}

# 下载 OpenTelemetry Collector binary
download_collector_binary() {
    local download_url="$MANAGER_URL/api/v1/resources/binaries/otelcol-sysarmor_linux-x64"
    local binary_path="$INSTALL_DIR/$BINARY_NAME"
    
    log_info "从 Manager 下载 OpenTelemetry Collector binary..."
    log_info "下载地址: $download_url"
    
    if ! curl -L -f -o "$binary_path" "$download_url"; then
        log_error "下载 OpenTelemetry Collector binary 失败"
        log_info "请检查 Manager 服务是否正常运行"
        exit 1
    fi
    
    # 设置可执行权限
    chmod +x "$binary_path"
    
    # 验证下载的文件
    if [[ ! -x "$binary_path" ]]; then
        log_error "下载的 binary 文件无法执行"
        exit 1
    fi
    
    log_info "OpenTelemetry Collector binary 下载完成"
}

# 生成配置文件
generate_config_file() {
    log_info "生成配置文件: $CONFIG_FILE"
    
    cat > "$INSTALL_DIR/$CONFIG_FILE" << 'EOF'
{{.ExtraCfgData}}
EOF

    if [[ ! -f "$CONFIG_FILE" ]]; then
        log_error "配置文件生成失败"
        exit 1
    fi
    
    log_info "配置文件生成完成"
}

# 创建启动脚本
create_startup_script() {
    local startup_script="$INSTALL_DIR/start.sh"
    
    log_info "创建启动脚本: $startup_script"
    
    cat > "$startup_script" << EOF
#!/bin/bash
# SysArmor OpenTelemetry Collector 启动脚本

cd "$INSTALL_DIR"

# 检查配置文件是否存在
if [[ ! -f "$CONFIG_FILE" ]]; then
    echo "错误: 配置文件不存在: $CONFIG_FILE"
    exit 1
fi

# 检查 binary 文件是否存在
if [[ ! -x "./$BINARY_NAME" ]]; then
    echo "错误: OpenTelemetry Collector binary 不存在或无法执行"
    exit 1
fi

# 使用 cpulimit 限制 CPU 使用率并启动服务
echo "启动 SysArmor OpenTelemetry Collector (CPU 限制: 15%)..."
exec cpulimit -f -l 15 -- ./$BINARY_NAME --config="$CONFIG_FILE"
EOF

    chmod +x "$startup_script"
    log_info "启动脚本创建完成"
}

# 启动服务
start_service() {
    local startup_script="$INSTALL_DIR/start.sh"
    local log_file="$INSTALL_DIR/otelcol.log"
    
    log_info "启动 SysArmor OpenTelemetry Collector 服务..."
    
    # 后台启动服务
    nohup "$startup_script" > "$log_file" 2>&1 &
    local service_pid=$!
    
    # 等待服务启动
    sleep 3
    
    # 检查服务是否成功启动
    if ! pgrep -f "$BINARY_NAME" >/dev/null; then
        log_error "服务启动失败"
        log_info "查看日志文件: $log_file"
        if [[ -f "$log_file" ]]; then
            log_info "最近的日志输出:"
            tail -n 10 "$log_file"
        fi
        exit 1
    fi
    
    local pid=$(pgrep -f "$BINARY_NAME")
    log_info "服务启动成功 (PID: $pid)"
    log_info "日志文件: $log_file"
}

# 验证安装
verify_installation() {
    log_info "验证安装..."
    
    # 检查进程是否在运行
    if ! pgrep -f "$BINARY_NAME" >/dev/null; then
        log_error "OpenTelemetry Collector 进程未在运行"
        return 1
    fi
    
    local pid=$(pgrep -f "$BINARY_NAME")
    log_info "OpenTelemetry Collector 进程运行正常 (PID: $pid)"
    
    # 检查健康检查端点
    log_info "检查健康状态端点..."
    sleep 5  # 等待服务完全启动
    
    if command -v curl >/dev/null; then
        if curl -s --connect-timeout 5 http://localhost:13133 >/dev/null; then
            log_info "健康检查端点响应正常"
        else
            log_warn "健康检查端点暂时无法访问，服务可能仍在启动中"
        fi
    fi
    
    log_info "安装验证完成"
}

# 生成管理命令提示
print_management_commands() {
    log_info "========================"
    log_info "SysArmor OpenTelemetry Collector 安装完成！"
    log_info "========================"
    echo
    log_info "管理命令:"
    echo "  查看服务状态: ps aux | grep $BINARY_NAME"
    echo "  停止服务:     pkill -f $BINARY_NAME"
    echo "  重启服务:     $INSTALL_DIR/start.sh"
    echo "  查看日志:     tail -f $INSTALL_DIR/otelcol.log"
    echo "  健康检查:     curl http://localhost:13133"
    echo "  配置文件:     $CONFIG_FILE"
    echo
    log_info "收集器ID: $COLLECTOR_ID"
    log_info "安装目录: $INSTALL_DIR"
}

# 清理函数
cleanup() {
    local exit_code=$?
    if [[ $exit_code -ne 0 ]]; then
        log_error "安装过程中发生错误 (退出码: $exit_code)"
        log_info "你可以尝试以下操作:"
        log_info "  1. 检查网络连接到 Manager 服务"
        log_info "  2. 确认 Manager 服务正常运行"
        log_info "  3. 查看安装日志获取更多信息"
        if [[ -f "$INSTALL_DIR/otelcol.log" ]]; then
            log_info "  4. 查看服务日志: cat $INSTALL_DIR/otelcol.log"
        fi
    fi
}

# 主函数
main() {
    trap cleanup EXIT
    
    log_info "SysArmor OpenTelemetry Collector 安装脚本"
    log_info "========================================="
    log_info "收集器ID: $COLLECTOR_ID"
    log_info "Manager URL: $MANAGER_URL"
    echo
    
    check_root
    check_dependencies
    check_existing_installation
    install_system_dependencies
    create_install_directory
    download_collector_binary
    generate_config_file
    create_startup_script
    start_service
    verify_installation
    print_management_commands
}

# 执行主函数
main "$@"
