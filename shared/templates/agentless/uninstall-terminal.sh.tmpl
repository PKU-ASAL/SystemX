#!/bin/bash
# SysArmor ç»ˆç«¯å¸è½½è„šæœ¬ (æ— ä»£ç†æ¨¡å¼)
# è‡ªåŠ¨ç”Ÿæˆï¼Œæ”¶é›†å™¨ID: {{.CollectorID}}
# ç”Ÿæˆæ—¶é—´: {{.GeneratedAt}}
#
# è„šæœ¬åŠŸèƒ½è¯´æ˜:
# ============
#
# 1. é¢„æ£€æŸ¥é˜¶æ®µ (Pre-uninstall Checks)
#    - æ£€æŸ¥ root æƒé™ï¼šç¡®ä¿æœ‰è¶³å¤Ÿæƒé™ä¿®æ”¹ç³»ç»Ÿé…ç½®
#    - å®‰è£…çŠ¶æ€æ£€æŸ¥ï¼šéªŒè¯ SysArmor æ˜¯å¦å·²å®‰è£…
#    - æ”¶é›†å™¨IDéªŒè¯ï¼šç¡®ä¿å¸è½½æ­£ç¡®çš„æ”¶é›†å™¨å®ä¾‹
#
# 2. å¤‡ä»½é˜¶æ®µ (Backup Phase)
#    - å¤‡ä»½å½“å‰é…ç½®ï¼šä¿å­˜æ‰€æœ‰ SysArmor ç›¸å…³é…ç½®æ–‡ä»¶
#    - åˆ›å»ºæ—¶é—´æˆ³å¤‡ä»½ç›®å½•ï¼š/tmp/sysarmor-uninstall-backup-YYYYMMDD-HHMMSS
#    - æ”¯æŒé…ç½®æ¢å¤å’Œé—®é¢˜æ’æŸ¥
#
# 3. æœåŠ¡åœæ­¢é˜¶æ®µ (Service Shutdown Phase)
#    - åœæ­¢ rsyslogï¼šæ–­å¼€åˆ° Vector çš„æ•°æ®è¿æ¥
#    - éªŒè¯è¿æ¥æ–­å¼€ï¼šç¡®è®¤æ²¡æœ‰æ´»è·ƒçš„ç½‘ç»œè¿æ¥
#    - åœæ­¢ auditdï¼šåœæ­¢å®¡è®¡äº‹ä»¶æ”¶é›†
#    - ç­‰å¾…æœåŠ¡å®Œå…¨åœæ­¢
#
# 4. é…ç½®æ¸…ç†é˜¶æ®µ (Configuration Cleanup Phase)
#    - åˆ é™¤ rsyslog é…ç½®ï¼š/etc/rsyslog.d/99-sysarmor.conf
#    - åˆ é™¤ audit è§„åˆ™ï¼š/etc/audit/rules.d/sysarmor.rules
#    - æ¸…ç†é˜Ÿåˆ—æ–‡ä»¶ï¼š/var/spool/rsyslog/sysarmor_queue*
#    - åˆ é™¤é…ç½®ç›®å½•ï¼š/etc/sysarmor/
#
# 5. ç³»ç»Ÿæ¢å¤é˜¶æ®µ (System Restoration Phase)
#    - æ¢å¤é»˜è®¤ auditd é…ç½®ï¼šé‡ç½®ä¸ºç³»ç»Ÿé»˜è®¤è®¾ç½®
#    - æ¸…ç†å½“å‰å®¡è®¡è§„åˆ™ï¼šç§»é™¤æ‰€æœ‰ SysArmor è§„åˆ™
#    - é‡æ–°ç”Ÿæˆè§„åˆ™ï¼šä½¿ç”¨ augenrules --load é‡æ–°åŠ è½½
#
# 6. æœåŠ¡é‡å¯é˜¶æ®µ (Service Restart Phase)
#    - å¯åŠ¨ auditdï¼šæ¢å¤ç³»ç»Ÿå®¡è®¡åŠŸèƒ½
#    - å¯åŠ¨ rsyslogï¼šæ¢å¤ç³»ç»Ÿæ—¥å¿—åŠŸèƒ½
#    - ç­‰å¾…æœåŠ¡ç¨³å®šï¼šç¡®ä¿æœåŠ¡æ­£å¸¸è¿è¡Œ
#
# 7. è¿æ¥éªŒè¯é˜¶æ®µ (Connection Verification Phase)
#    - æ£€æŸ¥æ®‹ç•™è¿æ¥ï¼šç¡®è®¤æ²¡æœ‰åˆ° Vector çš„æ´»è·ƒè¿æ¥
#    - è‡ªåŠ¨é‡å¯å¤„ç†ï¼šå¦‚æœå‘ç°è¿æ¥ï¼Œè‡ªåŠ¨é‡å¯ rsyslog æ–­å¼€
#    - æœ€ç»ˆéªŒè¯ï¼šç¡®ä¿è¿æ¥å®Œå…¨æ–­å¼€
#
# 8. å®Œæ•´æ€§éªŒè¯é˜¶æ®µ (Integrity Verification Phase)
#    - æœåŠ¡çŠ¶æ€æ£€æŸ¥ï¼šç¡®è®¤ auditd å’Œ rsyslog è¿è¡Œæ­£å¸¸
#    - é…ç½®æ–‡ä»¶æ£€æŸ¥ï¼šç¡®è®¤æ‰€æœ‰ SysArmor æ–‡ä»¶å·²åˆ é™¤
#    - å®¡è®¡è§„åˆ™æ£€æŸ¥ï¼šç¡®è®¤æ²¡æœ‰æ®‹ç•™çš„ SysArmor è§„åˆ™
#    - ç”Ÿæˆå¸è½½æŠ¥å‘Šï¼šæä¾›éªŒè¯å‘½ä»¤å’Œæ•…éšœæ’é™¤ä¿¡æ¯
#
# å…³é”®ä¿®å¤è¯´æ˜:
# ============
# - è‡ªåŠ¨è¿æ¥æ–­å¼€ï¼šæ£€æµ‹åˆ°æ®‹ç•™è¿æ¥æ—¶è‡ªåŠ¨é‡å¯ rsyslog
# - ç®€åŒ–éªŒè¯é€»è¾‘ï¼šç§»é™¤å†—é•¿çš„å¾ªç¯ç­‰å¾…ï¼Œæ”¹ä¸ºä¸€æ¬¡æ€§æ£€æŸ¥
# - é”™è¯¯å¤„ç†ä¼˜åŒ–ï¼šä¿®å¤æ•´æ•°æ¯”è¾ƒ bugï¼Œæ”¹è¿›é”™è¯¯æç¤º
# - ç”¨æˆ·ä½“éªŒæ”¹è¿›ï¼šå‡å°‘ç­‰å¾…æ—¶é—´ï¼Œæä¾›æ¸…æ™°çš„æ“ä½œåé¦ˆ
#
# æ•°æ®æµå‘æ¸…ç†:
# ============
# åœæ­¢: audit äº‹ä»¶ âŒ /var/log/audit/audit.log âŒ rsyslog âŒ Vector
# æ¸…ç†: é…ç½®æ–‡ä»¶ã€é˜Ÿåˆ—æ–‡ä»¶ã€è§„åˆ™æ–‡ä»¶ã€å…ƒæ•°æ®æ–‡ä»¶
# æ¢å¤: é»˜è®¤ç³»ç»Ÿé…ç½®ï¼Œæ­£å¸¸çš„å®¡è®¡å’Œæ—¥å¿—åŠŸèƒ½
#
# å®‰å…¨è€ƒè™‘:
# ========
# - å®Œæ•´æ¸…ç†ï¼šç¡®ä¿æ²¡æœ‰æ®‹ç•™çš„ç›‘æ§é…ç½®
# - ç³»ç»Ÿç¨³å®šï¼šä¿è¯å¸è½½åç³»ç»ŸæœåŠ¡æ­£å¸¸
# - æ•°æ®ä¿æŠ¤ï¼šå¤‡ä»½æ‰€æœ‰é…ç½®ä»¥é˜²è¯¯æ“ä½œ
# - è¿æ¥å®‰å…¨ï¼šç¡®ä¿æ²¡æœ‰æœªæˆæƒçš„æ•°æ®ä¼ è¾“

set -e

# é…ç½®å˜é‡
COLLECTOR_ID="{{.CollectorID}}"
WORKER_HOST="{{.WorkerHost}}"
WORKER_PORT="{{.WorkerPort}}"
CONFIG_DIR="/etc/sysarmor"
RSYSLOG_CONFIG="/etc/rsyslog.d/99-sysarmor.conf"
AUDIT_RULES="/etc/audit/rules.d/sysarmor.rules"

echo "ğŸ—‘ï¸  SysArmor å¸è½½å¼€å§‹..."
echo "æ”¶é›†å™¨ID: $COLLECTOR_ID"
echo ""

# æƒé™æ£€æŸ¥
if [[ $EUID -ne 0 ]]; then
   echo "âŒ è¯·ä½¿ç”¨ root æƒé™è¿è¡Œæ­¤è„šæœ¬ (ä½¿ç”¨ sudo)"
   exit 1
fi

# å®‰è£…æ£€æŸ¥
if [ ! -f "$CONFIG_DIR/collector_id" ]; then
    echo "â„¹ï¸  æœªå‘ç° SysArmor æ”¶é›†å™¨"
    echo "âœ… ç³»ç»Ÿå·²ç»æ˜¯å¹²å‡€çŠ¶æ€"
    exit 0
fi

# ID éªŒè¯
INSTALLED_ID=$(cat "$CONFIG_DIR/collector_id" 2>/dev/null || echo "")
if [ "$INSTALLED_ID" != "$COLLECTOR_ID" ]; then
    echo "âš ï¸  æ”¶é›†å™¨IDä¸åŒ¹é…:"
    echo "    æœŸæœ›: $COLLECTOR_ID"
    echo "    å‘ç°: $INSTALLED_ID"
    echo "âŒ æ­¤å¸è½½è„šæœ¬ç”¨äºä¸åŒçš„æ”¶é›†å™¨"
    exit 1
fi

# å¤‡ä»½é…ç½®
echo "ğŸ’¾ å¤‡ä»½å½“å‰é…ç½®..."
BACKUP_DIR="/tmp/sysarmor-uninstall-backup-$(date +%Y%m%d-%H%M%S)"
mkdir -p "$BACKUP_DIR"
for file in "$RSYSLOG_CONFIG" "$AUDIT_RULES" "/etc/audit/auditd.conf" "$CONFIG_DIR"; do
    if [ -e "$file" ]; then
        cp -r "$file" "$BACKUP_DIR/"
        echo "  - å·²å¤‡ä»½ $(basename $file)"
    fi
done

# å…³é”®ä¿®å¤ï¼šå…ˆåœæ­¢ rsyslog æ–­å¼€è¿æ¥
echo "ğŸ›‘ åœæ­¢æœåŠ¡å¹¶æ–­å¼€è¿æ¥..."
sudo systemctl stop rsyslog
echo "  - å·²åœæ­¢ rsyslog"
sleep 2

# éªŒè¯è¿æ¥æ–­å¼€
echo "ğŸ”Œ éªŒè¯è¿æ¥æ–­å¼€..."
ACTIVE_CONN=$(sudo ss -tupn | grep ":$WORKER_PORT" | grep rsyslog | wc -l)
if [ "$ACTIVE_CONN" -eq 0 ]; then
    echo "  âœ… rsyslog è¿æ¥å·²æ–­å¼€"
else
    echo "  âš ï¸  æ£€æµ‹åˆ° $ACTIVE_CONN ä¸ªæ´»è·ƒè¿æ¥"
fi

# åœæ­¢ auditd
sudo systemctl stop auditd
echo "  - å·²åœæ­¢ auditd"

# æ¸…ç†é…ç½®æ–‡ä»¶
echo "ğŸ§¹ æ¸…ç†é…ç½®æ–‡ä»¶..."
if [ -f "$RSYSLOG_CONFIG" ]; then
    sudo rm -f "$RSYSLOG_CONFIG"
    echo "  - å·²åˆ é™¤ rsyslog é…ç½®"
fi

if [ -f "$AUDIT_RULES" ]; then
    sudo rm -f "$AUDIT_RULES"
    echo "  - å·²åˆ é™¤ audit è§„åˆ™"
fi

# æ¸…ç†é˜Ÿåˆ—æ–‡ä»¶
if [ -d "/var/spool/rsyslog" ]; then
    sudo rm -f /var/spool/rsyslog/sysarmor_queue* 2>/dev/null || true
    echo "  - å·²æ¸…ç†é˜Ÿåˆ—æ–‡ä»¶"
fi

# æ¸…ç†é…ç½®ç›®å½•
if [ -d "$CONFIG_DIR" ]; then
    sudo rm -rf "$CONFIG_DIR"
    echo "  - å·²åˆ é™¤é…ç½®ç›®å½•"
fi

# æ¢å¤é»˜è®¤ auditd é…ç½®
echo "âš™ï¸ æ¢å¤é»˜è®¤é…ç½®..."
sudo tee /etc/audit/auditd.conf > /dev/null << 'EOF'
# é»˜è®¤ auditd é…ç½®
# ç”± SysArmor å¸è½½è„šæœ¬æ¢å¤

log_file = /var/log/audit/audit.log
log_format = RAW
log_group = adm
priority_boost = 4
flush = INCREMENTAL_ASYNC
freq = 50

max_log_file = 100
num_logs = 5
max_log_file_action = ROTATE

space_left = 75
space_left_action = SYSLOG
admin_space_left = 50
admin_space_left_action = SUSPEND
disk_full_action = SUSPEND
disk_error_action = SUSPEND

tcp_listen_queue = 5
tcp_max_per_addr = 1
tcp_client_ports = 1024-65535
tcp_client_max_idle = 0

name_format = HOSTNAME
plugin_dir = /etc/audit/plugins.d
distribute_network = no
write_logs = yes
EOF

# æ¸…ç† audit è§„åˆ™
echo "ğŸ”„ æ¸…ç†å®¡è®¡è§„åˆ™..."
sudo auditctl -D 2>/dev/null || true
sudo augenrules --load

# å…³é”®ä¿®å¤ï¼šé‡å¯æœåŠ¡å¹¶ç¡®ä¿è¿æ¥æ–­å¼€
echo "ğŸ”„ é‡å¯æœåŠ¡..."

# å¤„ç†auditdæœåŠ¡å¯åŠ¨ - æŸäº›ç³»ç»Ÿä¸å…è®¸ç›´æ¥é‡å¯
echo "  - å¯åŠ¨auditdæœåŠ¡..."
if sudo systemctl start auditd 2>/dev/null; then
    echo "    âœ… auditdå¯åŠ¨æˆåŠŸ"
else
    echo "    âš ï¸  auditdæ— æ³•é€šè¿‡systemctlå¯åŠ¨ï¼Œå°è¯•æ›¿ä»£æ–¹æ³•..."
    # å°è¯•ä¼ ç»ŸæœåŠ¡å‘½ä»¤
    if sudo service auditd start 2>/dev/null || sudo /sbin/service auditd start 2>/dev/null; then
        echo "    âœ… auditdå¯åŠ¨æˆåŠŸ"
    else
        echo "    âš ï¸  auditdå¯åŠ¨å¤±è´¥ï¼Œå¯èƒ½éœ€è¦é‡å¯ç³»ç»Ÿ"
        echo "    ğŸ’¡ å»ºè®®: é‡å¯ç³»ç»Ÿåauditdå°†è‡ªåŠ¨å¯åŠ¨"
    fi
fi

sleep 2

# å¯åŠ¨rsyslogæœåŠ¡
echo "  - å¯åŠ¨rsyslogæœåŠ¡..."
if sudo systemctl start rsyslog 2>/dev/null; then
    echo "    âœ… rsyslogå¯åŠ¨æˆåŠŸ"
else
    echo "    âš ï¸  rsyslogå¯åŠ¨å¯èƒ½æœ‰é—®é¢˜"
fi

sleep 3

# æœ€ç»ˆéªŒè¯è¿æ¥æ–­å¼€
echo "ğŸ” æœ€ç»ˆéªŒè¯..."
UNINSTALL_SUCCESS=true

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
for service in auditd rsyslog; do
    if sudo systemctl is-active --quiet $service; then
        echo "  âœ… $service è¿è¡Œæ­£å¸¸"
    else
        echo "  âš ï¸  $service å¯èƒ½æœ‰é—®é¢˜"
        UNINSTALL_SUCCESS=false
    fi
done

# æ£€æŸ¥é…ç½®æ–‡ä»¶æ¸…ç†
for file in "$RSYSLOG_CONFIG" "$AUDIT_RULES" "$CONFIG_DIR"; do
    if [ -e "$file" ]; then
        echo "  âš ï¸  $file ä»ç„¶å­˜åœ¨"
        UNINSTALL_SUCCESS=false
    fi
done

# å…³é”®éªŒè¯ï¼šæ£€æŸ¥æ˜¯å¦è¿˜æœ‰æ´»è·ƒè¿æ¥
RSYSLOG_CONN=$(sudo ss -tupn | grep ":$WORKER_PORT" | grep rsyslog | wc -l)
if [ "$RSYSLOG_CONN" -eq 0 ]; then
    echo "  âœ… ç¡®è®¤æ— æ´»è·ƒè¿æ¥"
else
    echo "  âš ï¸  ä»æœ‰ $RSYSLOG_CONN ä¸ªè¿æ¥åˆ° $WORKER_HOST:$WORKER_PORT"
    echo "  ğŸ”„ æ­£åœ¨é‡å¯ rsyslog æ–­å¼€è¿æ¥..."
    sudo systemctl restart rsyslog
    sleep 3
    
    # å†æ¬¡éªŒè¯è¿æ¥
    FINAL_CONN=$(sudo ss -tupn | grep ":$WORKER_PORT" | grep rsyslog | wc -l)
    if [ "$FINAL_CONN" -eq 0 ]; then
        echo "  âœ… è¿æ¥å·²æˆåŠŸæ–­å¼€"
    else
        echo "  âš ï¸  è¿æ¥ä»ç„¶å­˜åœ¨ï¼Œå¯èƒ½éœ€è¦æ‰‹åŠ¨å¤„ç†"
        UNINSTALL_SUCCESS=false
    fi
fi

# æ£€æŸ¥ SysArmor ç›¸å…³è§„åˆ™ (ä¿®å¤æ•´æ•°æ¯”è¾ƒbug)
SYSARMOR_RULES=$(sudo auditctl -l 2>/dev/null | grep -E "(suspicious_activity|privilege_escalation|sensitive_files|system_binaries|network_connections|authentication|scheduled_tasks)" | wc -l)
if [ "$SYSARMOR_RULES" -gt 0 ]; then
    echo "  âš ï¸  ä»æœ‰ $SYSARMOR_RULES æ¡ SysArmor è§„åˆ™"
fi

# æœ€ç»ˆç»“æœ
if [ "$UNINSTALL_SUCCESS" = true ]; then
    echo ""
    echo "ğŸ‰ SysArmor å¸è½½æˆåŠŸï¼"
    echo ""
    echo "ğŸ“‹ å¸è½½æ‘˜è¦:"
    echo "  - æ”¶é›†å™¨ID: $COLLECTOR_ID"
    echo "  - rsyslog é…ç½®: å·²åˆ é™¤"
    echo "  - audit è§„åˆ™: å·²åˆ é™¤"
    echo "  - é…ç½®ç›®å½•: å·²åˆ é™¤"
    echo "  - è¿æ¥çŠ¶æ€: å·²æ–­å¼€"
    echo "  - å¤‡ä»½ä½ç½®: $BACKUP_DIR"
    echo ""
    echo "ğŸ” éªŒè¯å‘½ä»¤:"
    echo "  sudo systemctl status rsyslog auditd"
    echo "  sudo ss -tupn | grep :$WORKER_PORT"
    echo "  sudo auditctl -l"
else
    echo ""
    echo "âš ï¸  å¸è½½å®Œæˆä½†å­˜åœ¨è­¦å‘Šï¼Œè¯·æ£€æŸ¥ä¸Šè¿°é—®é¢˜"
    echo ""
    echo "ğŸ’¡ å¦‚æœè¿æ¥ä»ç„¶å­˜åœ¨ï¼Œè¯·æ‰‹åŠ¨é‡å¯ rsyslog:"
    echo "    sudo systemctl restart rsyslog"
fi

echo ""
echo "âš ï¸  é‡è¦æé†’:"
echo "   - è¯·åœ¨ SysArmor ç®¡ç†ç•Œé¢åˆ é™¤æ­¤æ”¶é›†å™¨è®°å½•"
echo "   - é…ç½®å¤‡ä»½ä¿å­˜åœ¨: $BACKUP_DIR"
