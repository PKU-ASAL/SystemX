# SysArmor Middleware Makefile
# ç®¡ç† Kafka + Vector ä¸­é—´ä»¶æœåŠ¡

# åŠ è½½ .env æ–‡ä»¶
include .env
export

.PHONY: help up down restart logs status health clean

# ä»ç¯å¢ƒå˜é‡è¯»å–é…ç½®ï¼Œæä¾›é»˜è®¤å€¼ (KRaftæ¨¡å¼ï¼Œæ— éœ€Zookeeper)
KAFKA_PORT ?= 9092
KAFKA_EXTERNAL_PORT ?= 9094
VECTOR_API_PORT ?= 8686
VECTOR_METRICS_PORT ?= 9598
VECTOR_TCP_PORT ?= 514
KAFKA_UI_PORT ?= 8080
PROMETHEUS_PORT ?= 9090
YOUR_PUBLIC_IP ?= localhost

# è‡ªåŠ¨æ£€æµ‹ Docker Compose å‘½ä»¤ (å…¼å®¹æ–°æ—§ç‰ˆæœ¬)
DOCKER_COMPOSE := $(shell if command -v docker-compose >/dev/null 2>&1; then echo "docker-compose"; elif docker compose version >/dev/null 2>&1; then echo "docker compose"; else echo "docker-compose"; fi)

# é»˜è®¤ç›®æ ‡
help:
	@echo "SysArmor Middleware ç®¡ç†å·¥å…·"
	@echo "============================="
	@echo ""
	@echo "ğŸš€ åŸºç¡€å‘½ä»¤:"
	@echo "  up                       - å¯åŠ¨æ‰€æœ‰ä¸­é—´ä»¶æœåŠ¡"
	@echo "  down                     - åœæ­¢æ‰€æœ‰ä¸­é—´ä»¶æœåŠ¡"
	@echo "  restart                  - é‡å¯æ‰€æœ‰ä¸­é—´ä»¶æœåŠ¡"
	@echo "  logs                     - æŸ¥çœ‹æ‰€æœ‰æœåŠ¡æ—¥å¿—"
	@echo "  status                   - æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
	@echo "  health                   - ç»¼åˆå¥åº·æ£€æŸ¥"
	@echo "  clean                    - æ¸…ç†å®¹å™¨"
	@echo ""
	@echo "ğŸ“¨ Kafka ç®¡ç†:"
	@echo "  kafka-topics             - åˆ—å‡ºæ‰€æœ‰ topics"
	@echo "  kafka-create TOPIC=name  - åˆ›å»º topic"
	@echo "  kafka-consume TOPIC=name - æ¶ˆè´¹æ¶ˆæ¯"
	@echo ""
	@echo "ğŸ“Š Vector ç®¡ç†:"
	@echo "  vector-health            - Vector å¥åº·æ£€æŸ¥"
	@echo "  vector-metrics           - æŸ¥çœ‹ Vector æŒ‡æ ‡"
	@echo ""
	@echo "ğŸ“‹ ç›‘æ§ç®¡ç†:"
	@echo "  setup-monitoring         - è®¾ç½®ç›‘æ§ç»„ä»¶"
	@echo "  monitoring-health        - ç›‘æ§ç³»ç»Ÿå¥åº·æ£€æŸ¥"
	@echo "  key-metrics              - æŸ¥çœ‹å…³é”®æŒ‡æ ‡"
	@echo "  prometheus-ui            - æ‰“å¼€ Prometheus UI"
	@echo "  query-examples           - å¸¸ç”¨æŒ‡æ ‡æŸ¥è¯¢ç¤ºä¾‹"
	@echo ""
	@echo "ğŸ“‹ æœåŠ¡è®¿é—®:"
	@echo "  - Vector API:    http://$(YOUR_PUBLIC_IP):$(VECTOR_API_PORT)"
	@echo "  - Kafka UI:      http://$(YOUR_PUBLIC_IP):$(KAFKA_UI_PORT)"
	@echo "  - Kafka ex-port: $(YOUR_PUBLIC_IP):$(KAFKA_EXTERNAL_PORT)"
	@echo "  - Prometheus:    http://$(YOUR_PUBLIC_IP):$(PROMETHEUS_PORT)"
	@echo "  - Agent TCP:     $(YOUR_PUBLIC_IP):$(VECTOR_TCP_PORT)"

# å¯åŠ¨æ‰€æœ‰æœåŠ¡
up:
	@echo "ğŸš€ å¯åŠ¨ SysArmor Middleware..."
	@$(DOCKER_COMPOSE) --env-file .env up -d
	@echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
	@sleep 15
	@echo "âœ… SysArmor Middleware å¯åŠ¨å®Œæˆ!"
	@echo ""
	@echo "ğŸ“Š æœåŠ¡è®¿é—®åœ°å€:"
	@echo "  - Vector API:    http://$(YOUR_PUBLIC_IP):$(VECTOR_API_PORT)"
	@echo "  - Kafka UI:      http://$(YOUR_PUBLIC_IP):$(KAFKA_UI_PORT)"
	@echo "  - Prometheus:    http://$(YOUR_PUBLIC_IP):$(PROMETHEUS_PORT)"
	@echo "  - Agent TCP:     $(YOUR_PUBLIC_IP):$(VECTOR_TCP_PORT)"
	@echo ""
	@echo "ğŸ“ˆ ç›‘æ§æŒ‡æ ‡ç«¯ç‚¹:"
	@echo "  - Vector æŒ‡æ ‡:   	http://$(YOUR_PUBLIC_IP):$(VECTOR_METRICS_PORT)/metrics"
	@echo "  - Kafka JMX æŒ‡æ ‡:  http://$(YOUR_PUBLIC_IP):7071/metrics"
	@echo "  - Prometheus API: http://$(YOUR_PUBLIC_IP):$(PROMETHEUS_PORT)/api/v1/query"
	@echo "ğŸ”§ ç›‘æ§ç®¡ç†å‘½ä»¤:"
	@echo "  - ç›‘æ§å¥åº·æ£€æŸ¥:    make monitoring-health"
	@echo "  - æŸ¥çœ‹å…³é”®æŒ‡æ ‡:    make key-metrics"
	@echo "  - æ‰“å¼€ Prometheus: make prometheus-ui"

# åœæ­¢æ‰€æœ‰æœåŠ¡
down:
	@echo "ğŸ›‘ åœæ­¢ SysArmor Middleware..."
	@$(DOCKER_COMPOSE) down
	@echo "âœ… æ‰€æœ‰æœåŠ¡å·²åœæ­¢"

# é‡å¯æ‰€æœ‰æœåŠ¡
restart:
	@echo "ğŸ”„ é‡å¯ SysArmor Middleware..."
	@$(MAKE) down
	@sleep 3
	@$(MAKE) up

# æŸ¥çœ‹æ‰€æœ‰æœåŠ¡æ—¥å¿—
logs:
	@echo "ğŸ“‹ æŸ¥çœ‹æ‰€æœ‰æœåŠ¡æ—¥å¿—..."
	@$(DOCKER_COMPOSE) logs -f

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
status:
	@echo "ğŸ” æ£€æŸ¥ SysArmor Middleware æœåŠ¡çŠ¶æ€..."
	@$(DOCKER_COMPOSE) ps 2>/dev/null || echo "âŒ æœåŠ¡æœªè¿è¡Œ"
	@echo ""
	@$(MAKE) health

# ç»¼åˆå¥åº·æ£€æŸ¥ (KRaftæ¨¡å¼ï¼Œæ— éœ€Zookeeper)
health:
	@echo "ğŸ¥ SysArmor Middleware å¥åº·æ£€æŸ¥ (KRaftæ¨¡å¼)..."
	@echo ""
	@echo "=== Kafka (KRaftæ¨¡å¼) ==="
	@if docker exec sysarmor-middleware-kafka kafka-broker-api-versions --bootstrap-server localhost:$(KAFKA_PORT) >/dev/null 2>&1; then \
		echo "âœ… Kafka: å¥åº·è¿è¡Œ (KRaftæ¨¡å¼ï¼Œç«¯å£ $(KAFKA_PORT))"; \
	else \
		echo "âŒ Kafka: å¼‚å¸¸æˆ–æœªå¯åŠ¨"; \
	fi
	@echo ""
	@echo "=== Vector ==="
	@if curl -s http://$(YOUR_PUBLIC_IP):$(VECTOR_API_PORT)/health >/dev/null 2>&1; then \
		echo "âœ… Vector: å¥åº·è¿è¡Œ (http://$(YOUR_PUBLIC_IP):$(VECTOR_API_PORT))"; \
	else \
		echo "âŒ Vector: å¼‚å¸¸æˆ–æœªå¯åŠ¨"; \
	fi
	@echo ""
	@echo "=== Kafka UI ==="
	@if curl -s http://$(YOUR_PUBLIC_IP):$(KAFKA_UI_PORT) >/dev/null 2>&1; then \
		echo "âœ… Kafka UI: å¥åº·è¿è¡Œ (http://$(YOUR_PUBLIC_IP):$(KAFKA_UI_PORT))"; \
	else \
		echo "âŒ Kafka UI: å¼‚å¸¸æˆ–æœªå¯åŠ¨"; \
	fi
	@echo ""
	@echo "=== Prometheus ==="
	@if curl -s http://$(YOUR_PUBLIC_IP):$(PROMETHEUS_PORT)/-/healthy >/dev/null 2>&1; then \
		echo "âœ… Prometheus: å¥åº·è¿è¡Œ (http://$(YOUR_PUBLIC_IP):$(PROMETHEUS_PORT))"; \
	else \
		echo "âŒ Prometheus: å¼‚å¸¸æˆ–æœªå¯åŠ¨"; \
	fi

# æ¸…ç†å®¹å™¨
clean:
	@echo "ğŸ§¹ æ¸…ç† SysArmor Middleware å®¹å™¨..."
	@$(DOCKER_COMPOSE) down
	@$(DOCKER_COMPOSE) rm -f
	@echo "âœ… å®¹å™¨æ¸…ç†å®Œæˆ"

# å®Œå…¨æ¸…ç† (åŒ…æ‹¬æ•°æ®å·å’Œç¼“å­˜)
clean-all:
	@echo "ğŸ—‘ï¸  æ‰§è¡Œå®Œå…¨æ¸…ç†..."
	@echo "ğŸ›‘ åœæ­¢æ‰€æœ‰æœåŠ¡..."
	@$(DOCKER_COMPOSE) down --volumes --remove-orphans
	@echo "ğŸ§¹ æ¸…ç†å®¹å™¨ã€ç½‘ç»œå’Œæ•°æ®å·..."
	@$(DOCKER_COMPOSE) rm -f
	@echo "ğŸ—‘ï¸  æ¸…ç†æœªä½¿ç”¨çš„é•œåƒ..."
	@docker image prune -f
	@echo "ğŸ—‘ï¸  æ¸…ç†æœªä½¿ç”¨çš„æ•°æ®å·..."
	@docker volume prune -f
	@echo "ğŸ—‘ï¸  æ¸…ç†æ„å»ºç¼“å­˜..."
	@docker builder prune -f
	@echo "âœ… å®Œå…¨æ¸…ç†å®Œæˆ"

# é‡å»ºå¹¶å¯åŠ¨ (æ¸…ç†ç¼“å­˜)
rebuild:
	@echo "ğŸ”¨ é‡å»º SysArmor Middleware (æ¸…ç†ç¼“å­˜)..."
	@echo "ğŸ›‘ åœæ­¢ç°æœ‰æœåŠ¡..."
	@$(DOCKER_COMPOSE) down --volumes --remove-orphans
	@echo "ğŸ§¹ æ¸…ç†æ„å»ºç¼“å­˜..."
	@docker builder prune -f
	@echo "ğŸ”¨ é‡æ–°æ„å»ºé•œåƒ (æ— ç¼“å­˜)..."
	@$(DOCKER_COMPOSE) build --no-cache
	@echo "ğŸš€ å¯åŠ¨æœåŠ¡..."
	@$(DOCKER_COMPOSE) up -d
	@echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
	@sleep 20
	@echo "âœ… é‡å»ºå®Œæˆ!"
	@$(MAKE) health

# å¿«é€Ÿé‡å»º (ä¿ç•™ç¼“å­˜)
rebuild-fast:
	@echo "âš¡ å¿«é€Ÿé‡å»º SysArmor Middleware..."
	@$(DOCKER_COMPOSE) down
	@$(DOCKER_COMPOSE) build
	@$(DOCKER_COMPOSE) up -d
	@echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
	@sleep 15
	@echo "âœ… å¿«é€Ÿé‡å»ºå®Œæˆ!"
	@$(MAKE) health

# Vector å¥åº·æ£€æŸ¥
vector-health:
	@echo "ğŸ¥ Vector å¥åº·æ£€æŸ¥..."
	@curl -s http://$(YOUR_PUBLIC_IP):$(VECTOR_API_PORT)/health | jq . 2>/dev/null || echo "âŒ æ— æ³•è¿æ¥åˆ° Vector API"

# Vector æŒ‡æ ‡
vector-metrics:
	@echo "ğŸ“Š Vector æŒ‡æ ‡..."
	@curl -s http://$(YOUR_PUBLIC_IP):$(VECTOR_METRICS_PORT)/metrics 2>/dev/null || echo "âŒ æ— æ³•è·å– Vector æŒ‡æ ‡"

# Kafka Topics åˆ—è¡¨
kafka-topics:
	@echo "ğŸ“‹ åˆ—å‡ºæ‰€æœ‰ Kafka topics..."
	@docker exec sysarmor-middleware-kafka kafka-topics --list --bootstrap-server localhost:$(KAFKA_PORT)

# åˆ›å»º Kafka Topic
kafka-create:
	@if [ -z "$(TOPIC)" ]; then \
		echo "âŒ è¯·æŒ‡å®š TOPIC åç§°: make kafka-create TOPIC=my-topic"; \
		exit 1; \
	fi
	@echo "ğŸ“¨ åˆ›å»º Kafka topic: $(TOPIC)..."
	@docker exec sysarmor-middleware-kafka kafka-topics \
		--create --bootstrap-server localhost:$(KAFKA_PORT) \
		--topic $(TOPIC) --partitions 3 --replication-factor 1
	@echo "âœ… Topic $(TOPIC) åˆ›å»ºæˆåŠŸ"

# æ¶ˆè´¹ Kafka æ¶ˆæ¯
kafka-consume:
	@if [ -z "$(TOPIC)" ]; then \
		echo "âŒ è¯·æŒ‡å®š TOPIC åç§°: make kafka-consume TOPIC=my-topic"; \
		exit 1; \
	fi
	@echo "ğŸ“¨ æ¶ˆè´¹ Kafka topic: $(TOPIC)..."
	@echo "æŒ‰ Ctrl+C åœæ­¢æ¶ˆè´¹"
	@docker exec -it sysarmor-middleware-kafka kafka-console-consumer \
		--bootstrap-server localhost:$(KAFKA_PORT) --topic $(TOPIC) --from-beginning

# === ç›‘æ§ç›¸å…³å‘½ä»¤ ===

# è®¾ç½®ç›‘æ§
setup-monitoring:
	@echo "ğŸ”§ è®¾ç½®ç›‘æ§ç»„ä»¶..."
	@./scripts/setup-monitoring.sh

# ç›‘æ§å¥åº·æ£€æŸ¥
monitoring-health:
	@echo "ğŸ¥ ç›‘æ§ç³»ç»Ÿå¥åº·æ£€æŸ¥..."
	@echo "=== Vector ==="
	@if curl -s http://localhost:$(VECTOR_METRICS_PORT)/health >/dev/null 2>&1; then \
		echo "âœ… Vector: å¥åº·è¿è¡Œ"; \
	else \
		echo "âŒ Vector: å¼‚å¸¸æˆ–æœªå¯åŠ¨"; \
	fi
	@echo ""
	@echo "=== Kafka JMX ==="
	@if curl -s http://localhost:7071/metrics >/dev/null 2>&1; then \
		echo "âœ… Kafka JMX: å¥åº·è¿è¡Œ"; \
	else \
		echo "âŒ Kafka JMX: å¼‚å¸¸æˆ–æœªå¯åŠ¨"; \
	fi
	@echo ""
	@echo "=== Prometheus ==="
	@if curl -s http://localhost:$(PROMETHEUS_PORT)/-/healthy >/dev/null 2>&1; then \
		echo "âœ… Prometheus: å¥åº·è¿è¡Œ"; \
	else \
		echo "âŒ Prometheus: å¼‚å¸¸æˆ–æœªå¯åŠ¨"; \
	fi

# æŸ¥çœ‹å…³é”®æŒ‡æ ‡
key-metrics:
	@echo "ğŸ“Š SysArmor Middleware å…³é”®æŒ‡æ ‡..."
	@echo ""
	@echo "=== Broker æ•´ä½“æŒ‡æ ‡ ==="
	@echo "æ€»æ¶ˆæ¯æ•°:"
	@curl -s "http://localhost:$(PROMETHEUS_PORT)/api/v1/query?query=kafka_broker_messages_total" | jq -r '.data.result[0].value[1] // "N/A"' 2>/dev/null || echo "N/A"
	@echo "æ¶ˆæ¯é€Ÿç‡ (msg/sec):"
	@curl -s "http://localhost:$(PROMETHEUS_PORT)/api/v1/query?query=kafka_broker_messages_per_sec" | jq -r '.data.result[0].value[1] // "N/A"' 2>/dev/null || echo "N/A"
	@echo "æ€»å­˜å‚¨ç©ºé—´ (bytes):"
	@curl -s "http://localhost:$(PROMETHEUS_PORT)/api/v1/query?query=kafka_broker_log_size_total_bytes" | jq -r '.data.result[0].value[1] // "N/A"' 2>/dev/null || echo "N/A"
	@echo "JVM å †å†…å­˜ä½¿ç”¨ (bytes):"
	@curl -s "http://localhost:$(PROMETHEUS_PORT)/api/v1/query?query=kafka_jvm_memory_heap_used_bytes" | jq -r '.data.result[0].value[1] // "N/A"' 2>/dev/null || echo "N/A"
	@echo ""
	@echo "=== Topic çº§åˆ«æŒ‡æ ‡ (å‰5ä¸ª) ==="
	@curl -s "http://localhost:$(PROMETHEUS_PORT)/api/v1/query?query=topk(5,kafka_topic_messages_total)" | jq -r '.data.result[]? | "\(.metric.topic): \(.value[1]) messages"' 2>/dev/null || echo "N/A"

# æ‰“å¼€ Prometheus UI
prometheus-ui:
	@echo "ğŸŒ æ‰“å¼€ Prometheus UI..."
	@open http://localhost:$(PROMETHEUS_PORT) 2>/dev/null || echo "è®¿é—®: http://localhost:$(PROMETHEUS_PORT)"

# å¸¸ç”¨ PromQL æŸ¥è¯¢ç¤ºä¾‹
query-examples:
	@echo "ğŸ“ˆ å¸¸ç”¨æŒ‡æ ‡æŸ¥è¯¢ç¤ºä¾‹..."
	@echo ""
	@echo "1. æ•´ä½“æ¶ˆæ¯é€Ÿç‡:"
	@echo "   kafka_broker_messages_per_sec"
	@echo ""
	@echo "2. æ¯ä¸ª Topic çš„æ¶ˆæ¯æ•°:"
	@echo "   kafka_topic_messages_total"
	@echo ""
	@echo "3. æ¯ä¸ª Topic çš„å­˜å‚¨ç©ºé—´:"
	@echo "   sum by (topic) (kafka_topic_partition_log_size_bytes)"
	@echo ""
	@echo "4. Top 5 æœ€æ´»è·ƒçš„ Topic:"
	@echo "   topk(5, rate(kafka_topic_messages_total[5m]))"
	@echo ""
	@echo "5. JVM å†…å­˜ä½¿ç”¨ç‡:"
	@echo "   kafka_jvm_memory_heap_used_bytes / kafka_jvm_memory_heap_max_bytes * 100"
	@echo ""
	@echo "6. Vector äº‹ä»¶å¤„ç†é€Ÿç‡:"
	@echo "   rate(vector_events_in_total[5m])"
	@echo ""
	@echo "7. Kafka å­—èŠ‚é€Ÿç‡:"
	@echo "   kafka_broker_bytes_in_per_sec"
