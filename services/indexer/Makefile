# SysArmor Indexer Makefile
# OpenSearch-based security event indexing and search service

# Docker parameters
COMPOSE_FILE=docker-compose.yml
PROJECT_NAME=sysarmor-indexer
OPENSEARCH_PORT=9201
DASHBOARDS_PORT=5602

# OpenSearch parameters
OPENSEARCH_USER=admin
OPENSEARCH_PASS=admin
OPENSEARCH_URL=http://localhost:$(OPENSEARCH_PORT)

.PHONY: help setup build up down restart status logs health test clean certs

# Default target
all: setup up

# Help
help:
	@echo "SysArmor Indexer - Available commands:"
	@echo ""
	@echo "üöÄ Setup & Deployment:"
	@echo "  setup         - Generate certificates and prepare environment"
	@echo "  build         - Build Docker images"
	@echo "  up            - Start all services"
	@echo "  down          - Stop all services"
	@echo "  restart       - Restart all services"
	@echo "  all           - Setup and start services"
	@echo ""
	@echo "üìä Monitoring:"
	@echo "  status        - Check service status"
	@echo "  logs          - View service logs"
	@echo "  health        - Check OpenSearch cluster health"
	@echo ""
	@echo "üîß Management:"
	@echo "  certs         - Generate SSL certificates"
	@echo "  templates     - Apply index templates"
	@echo "  test          - Run basic functionality tests"
	@echo "  clean         - Clean up containers and volumes"
	@echo ""
	@echo "üîç OpenSearch Operations:"
	@echo "  indices       - List all indices"
	@echo "  users         - List all users"
	@echo "  search        - Search recent events"
	@echo ""
	@echo "üìñ Documentation:"
	@echo "  docs          - Open documentation"
	@echo "  dashboards    - Open OpenSearch Dashboards"

# Generate SSL certificates
certs:
	@echo "üîê Generating SSL certificates..."
	@chmod +x scripts/generate-certs.sh
	@./scripts/generate-certs.sh
	@echo "‚úÖ SSL certificates generated"

# Setup environment
setup: certs
	@echo "üõ†Ô∏è  Setting up SysArmor Indexer environment..."
	@echo "‚úÖ Environment setup completed"

# Build Docker images
build:
	@echo "üî® Building Docker images..."
	docker compose -f $(COMPOSE_FILE) build
	@echo "‚úÖ Docker images built"

# Start services
up:
	@echo "üöÄ Starting SysArmor Indexer services..."
	docker compose -f $(COMPOSE_FILE) up -d
	@echo "‚úÖ Services started"
	@echo "üìñ OpenSearch API: $(OPENSEARCH_URL)"
	@echo "üìä OpenSearch Dashboards: http://localhost:$(DASHBOARDS_PORT)"
	@echo "üë§ Default credentials: $(OPENSEARCH_USER)/$(OPENSEARCH_PASS)"

# Stop services
down:
	@echo "üõë Stopping SysArmor Indexer services..."
	docker compose -f $(COMPOSE_FILE) down
	@echo "‚úÖ Services stopped"

# Restart services
restart: down up
	@echo "üîÑ Services restarted"

# Check service status
status:
	@echo "üìä Checking service status..."
	docker compose -f $(COMPOSE_FILE) ps

# View logs
logs:
	@echo "üìã Viewing service logs..."
	docker compose -f $(COMPOSE_FILE) logs -f

# View OpenSearch logs only
logs-opensearch:
	@echo "üìã Viewing OpenSearch logs..."
	docker compose -f $(COMPOSE_FILE) logs -f opensearch

# View Dashboards logs only
logs-dashboards:
	@echo "üìã Viewing Dashboards logs..."
	docker compose -f $(COMPOSE_FILE) logs -f opensearch-dashboards

# Health check
health:
	@echo "üè• Checking OpenSearch cluster health..."
	@curl -s -u $(OPENSEARCH_USER):$(OPENSEARCH_PASS) "$(OPENSEARCH_URL)/_cluster/health?pretty" || echo "‚ùå Health check failed"

# Apply index templates
templates:
	@echo "üìã Applying index templates..."
	@curl -X PUT "$(OPENSEARCH_URL)/_index_template/sysarmor-events" \
		-u "$(OPENSEARCH_USER):$(OPENSEARCH_PASS)" \
		-H "Content-Type: application/json" \
		-d @templates/sysarmor-events-template.json
	@echo "‚úÖ Index templates applied"

# List indices
indices:
	@echo "üìã Listing all indices..."
	@curl -s -u $(OPENSEARCH_USER):$(OPENSEARCH_PASS) "$(OPENSEARCH_URL)/_cat/indices?v"

# List users
users:
	@echo "üë• Listing all users..."
	@curl -s -u $(OPENSEARCH_USER):$(OPENSEARCH_PASS) "$(OPENSEARCH_URL)/_plugins/_security/api/internalusers?pretty"

# Search recent events
search:
	@echo "üîç Searching recent events..."
	@curl -s -u $(OPENSEARCH_USER):$(OPENSEARCH_PASS) -X GET "$(OPENSEARCH_URL)/sysarmor-events-*/_search?pretty" \
		-H "Content-Type: application/json" \
		-d '{"query":{"range":{"@timestamp":{"gte":"now-1h"}}},"size":10,"sort":[{"@timestamp":{"order":"desc"}}]}'

# Run basic tests
test:
	@echo "üß™ Running basic functionality tests..."
	@echo "Testing OpenSearch connection..."
	@curl -s -u $(OPENSEARCH_USER):$(OPENSEARCH_PASS) "$(OPENSEARCH_URL)/_cluster/health" > /dev/null && echo "‚úÖ OpenSearch connection OK" || echo "‚ùå OpenSearch connection failed"
	@echo "Testing Dashboards connection..."
	@curl -s "http://localhost:$(DASHBOARDS_PORT)/api/status" > /dev/null && echo "‚úÖ Dashboards connection OK" || echo "‚ùå Dashboards connection failed"
	@echo "Testing index template..."
	@curl -s -u $(OPENSEARCH_USER):$(OPENSEARCH_PASS) "$(OPENSEARCH_URL)/_index_template/sysarmor-events" > /dev/null && echo "‚úÖ Index template exists" || echo "‚ö†Ô∏è  Index template not found"

# Test data ingestion
test-ingest:
	@echo "üß™ Testing data ingestion..."
	@curl -X POST "$(OPENSEARCH_URL)/sysarmor-events-$(shell date +%Y.%m.%d)/_doc" \
		-u "$(OPENSEARCH_USER):$(OPENSEARCH_PASS)" \
		-H "Content-Type: application/json" \
		-d @templates/sample-event.json
	@echo "‚úÖ Test event ingested"

# Clean up
clean:
	@echo "üßπ Cleaning up..."
	docker compose -f $(COMPOSE_FILE) down -v
	docker system prune -f
	@echo "‚úÖ Cleanup completed"

# Open documentation
docs:
	@echo "üìñ Opening documentation..."
	@if command -v open >/dev/null 2>&1; then \
		open docs/README.md; \
	elif command -v xdg-open >/dev/null 2>&1; then \
		xdg-open docs/README.md; \
	else \
		echo "üìñ Documentation: docs/README.md"; \
	fi

# Open OpenSearch Dashboards
dashboards:
	@echo "üìä Opening OpenSearch Dashboards..."
	@if command -v open >/dev/null 2>&1; then \
		open http://localhost:$(DASHBOARDS_PORT); \
	elif command -v xdg-open >/dev/null 2>&1; then \
		xdg-open http://localhost:$(DASHBOARDS_PORT); \
	else \
		echo "üìä OpenSearch Dashboards: http://localhost:$(DASHBOARDS_PORT)"; \
	fi

# Development helpers
dev-setup: setup templates
	@echo "üîß Development environment ready"

# Production deployment
prod-deploy: setup up templates
	@echo "üöÄ Production deployment completed"
	@echo "‚ö†Ô∏è  Remember to change default passwords in production!"

# Backup indices
backup:
	@echo "üíæ Creating backup..."
	@curl -X PUT "$(OPENSEARCH_URL)/_snapshot/backup_repo" \
		-u "$(OPENSEARCH_USER):$(OPENSEARCH_PASS)" \
		-H "Content-Type: application/json" \
		-d '{"type":"fs","settings":{"location":"/usr/share/opensearch/backup"}}'
	@curl -X PUT "$(OPENSEARCH_URL)/_snapshot/backup_repo/snapshot_$(shell date +%Y%m%d_%H%M%S)" \
		-u "$(OPENSEARCH_USER):$(OPENSEARCH_PASS)" \
		-H "Content-Type: application/json" \
		-d '{"indices":"sysarmor-events-*","ignore_unavailable":true,"include_global_state":false}'
	@echo "‚úÖ Backup created"

# Monitor performance
monitor:
	@echo "üìà Monitoring cluster performance..."
	@curl -s -u $(OPENSEARCH_USER):$(OPENSEARCH_PASS) "$(OPENSEARCH_URL)/_cluster/stats?pretty"
