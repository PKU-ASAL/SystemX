# Indexer 模块 - OpenSearch + Python 索引服务
services:
  opensearch:
    build:
      context: ../..
      dockerfile: ./services/indexer/opensearch.Dockerfile
    hostname: ${OPENSEARCH_HOST}
    environment:
      - discovery.type=single-node
      - DISABLE_SECURITY_PLUGIN=true
      - "OPENSEARCH_JAVA_OPTS=-Xms512m -Xmx512m"
      - cluster.name=sysarmor-indexer-cluster
      - node.name=${OPENSEARCH_HOST}-node-1
    ports:
      - "${OPENSEARCH_PORT}:${OPENSEARCH_PORT}"
    volumes:
      - indexer_opensearch_data:/usr/share/opensearch/data
      - ./configs/opensearch/opensearch.yml:/usr/share/opensearch/config/opensearch.yml:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${OPENSEARCH_PORT}/_cluster/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - ${SYSARMOR_NETWORK}
    labels:
      - "sysarmor.module=indexer"
      - "sysarmor.component=search-engine"

  indexer:
    build:
      context: ../..
      dockerfile: ./services/indexer/indexer.Dockerfile
    hostname: indexer-service
    depends_on:
      opensearch:
        condition: service_healthy
    environment:
      - OPENSEARCH_URL=${OPENSEARCH_URL}
      - OPENSEARCH_USERNAME=${OPENSEARCH_USERNAME}
      - OPENSEARCH_PASSWORD=${OPENSEARCH_PASSWORD}
      - INDEX_PREFIX=${INDEX_PREFIX}
    networks:
      - ${SYSARMOR_NETWORK}
    labels:
      - "sysarmor.module=indexer"
      - "sysarmor.component=index-service"

volumes:
  indexer_opensearch_data:
    name: sysarmor_indexer_opensearch_data

networks:
  ${SYSARMOR_NETWORK}:
    driver: bridge
    name: ${SYSARMOR_NETWORK}
