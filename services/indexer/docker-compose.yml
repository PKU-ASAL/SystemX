# Indexer 模块 - OpenSearch + Python 索引服务
services:
  opensearch:
    build:
      context: ../..
      dockerfile: ./services/indexer/opensearch.Dockerfile
    hostname: opensearch
    environment:
      - discovery.type=single-node
      - "OPENSEARCH_JAVA_OPTS=-Xms512m -Xmx512m"
      - cluster.name=sysarmor-indexer-cluster
      - node.name=opensearch-node-1
    ports:
      - "${OPENSEARCH_PORT}:${OPENSEARCH_PORT}"
    volumes:
      - indexer_opensearch_data:/usr/share/opensearch/data
      - ./configs/opensearch/opensearch.yml:/usr/share/opensearch/config/opensearch.yml:ro
      - ./configs/opensearch/certs:/usr/share/opensearch/config/certs:ro
    healthcheck:
      test: ["CMD", "curl", "-s", "-f", 
             "-u", "admin:${OPENSEARCH_PASSWORD}",
             "http://localhost:${OPENSEARCH_PORT}/_cluster/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    labels:
      - "sysarmor.module=indexer"
      - "sysarmor.component=search-engine"

  indexer:
    build:
      context: ../..
      dockerfile: ./services/indexer/indexer.Dockerfile
    hostname: indexer-service
    depends_on:
      opensearch:
        condition: service_healthy
    environment:
      - OPENSEARCH_URL=http://opensearch:${OPENSEARCH_PORT}
      - OPENSEARCH_USERNAME=${OPENSEARCH_USERNAME}
      - OPENSEARCH_PASSWORD=${OPENSEARCH_PASSWORD}
      - INDEX_PREFIX=${INDEX_PREFIX}
    labels:
      - "sysarmor.module=indexer"
      - "sysarmor.component=index-service"

volumes:
  indexer_opensearch_data:
    name: ${OPENSEARCH_DATA_VOLUME_NAME:-sysarmor_indexer_opensearch_data}
    external: ${OPENSEARCH_DATA_VOLUME_EXTERNAL:-false}

networks:
  default:
    name: ${SYSARMOR_NETWORK:-sysarmor-net}
    external: ${SYSARMOR_NETWORK_EXTERNAL:-false}
