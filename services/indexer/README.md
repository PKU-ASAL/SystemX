# SysArmor Indexer Service

SysArmorç´¢å¼•æœåŠ¡ï¼Œè´Ÿè´£ç®¡ç†OpenSearchç´¢å¼•æ¨¡æ¿å’Œç´¢å¼•ç”Ÿå‘½å‘¨æœŸã€‚

## ğŸ“ ç›®å½•ç»“æ„

```
services/indexer/
â”œâ”€â”€ configs/                    # é…ç½®æ–‡ä»¶
â”‚   â””â”€â”€ opensearch/            # OpenSearché…ç½®
â”‚       â”œâ”€â”€ opensearch.yml     # OpenSearchä¸»é…ç½®
â”‚       â””â”€â”€ certs/             # SSLè¯ä¹¦æ–‡ä»¶
â”œâ”€â”€ scripts/                   # è„šæœ¬æ–‡ä»¶
â”‚   â””â”€â”€ generate-certs.sh      # SSLè¯ä¹¦ç”Ÿæˆè„šæœ¬
â”œâ”€â”€ src/                       # æºä»£ç 
â”‚   â””â”€â”€ main.py               # ç´¢å¼•æœåŠ¡ä¸»ç¨‹åº
â”œâ”€â”€ templates/                 # ç´¢å¼•æ¨¡æ¿
â”‚   â””â”€â”€ sysarmor-events-template.json  # äº‹ä»¶ç´¢å¼•æ¨¡æ¿
â”œâ”€â”€ docker-compose.yml         # Docker Composeé…ç½®
â”œâ”€â”€ indexer.Dockerfile         # Pythonç´¢å¼•æœåŠ¡é•œåƒ
â”œâ”€â”€ opensearch.Dockerfile      # OpenSearchå®šåˆ¶é•œåƒ
â”œâ”€â”€ requirements.txt           # Pythonä¾èµ–
â””â”€â”€ README.md                  # æœ¬æ–‡æ¡£
```

## ğŸš€ åŠŸèƒ½ç‰¹æ€§

- **ç´¢å¼•æ¨¡æ¿ç®¡ç†**: è‡ªåŠ¨åŠ è½½å’Œåº”ç”¨OpenSearchç´¢å¼•æ¨¡æ¿
- **ç´¢å¼•ç”Ÿå‘½å‘¨æœŸ**: è‡ªåŠ¨åˆ›å»ºæŒ‰æœˆåˆ†å‰²çš„ç´¢å¼•
- **å¥åº·ç›‘æ§**: æŒç»­ç›‘æ§OpenSearché›†ç¾¤å¥åº·çŠ¶æ€
- **SSLå®‰å…¨**: æ”¯æŒSSLä¼ è¾“å±‚åŠ å¯†
- **å®¹å™¨åŒ–éƒ¨ç½²**: å®Œæ•´çš„Dockerå®¹å™¨åŒ–æ”¯æŒ

## ğŸ”§ æœåŠ¡ç»„ä»¶

### OpenSearch
- **ç‰ˆæœ¬**: 2.11.0
- **ç«¯å£**: 9200 (HTTP), 9300 (Transport)
- **å®‰å…¨**: SSLä¼ è¾“å±‚åŠ å¯†
- **å­˜å‚¨**: æŒä¹…åŒ–æ•°æ®å·

### Indexer Service
- **è¯­è¨€**: Python 3.11
- **åŠŸèƒ½**: ç´¢å¼•æ¨¡æ¿ç®¡ç†ã€ç´¢å¼•åˆ›å»ºã€å¥åº·æ£€æŸ¥
- **ä¾èµ–**: opensearch-py, requests, pyyaml

## ğŸ“‹ ç¯å¢ƒå˜é‡

| å˜é‡å | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|--------|------|
| `OPENSEARCH_URL` | `http://opensearch:9200` | OpenSearchè¿æ¥åœ°å€ |
| `OPENSEARCH_USERNAME` | `admin` | OpenSearchç”¨æˆ·å |
| `OPENSEARCH_PASSWORD` | `admin` | OpenSearchå¯†ç  |
| `INDEX_PREFIX` | `sysarmor-events` | ç´¢å¼•åç§°å‰ç¼€ |

## ğŸ› ï¸ éƒ¨ç½²è¯´æ˜

### å¿«é€Ÿéƒ¨ç½²
```bash
# ä»é¡¹ç›®æ ¹ç›®å½•
make init       # åˆå§‹åŒ–ç¯å¢ƒ (åŒ…å«SSLè¯ä¹¦ç”Ÿæˆ)
make up         # å¯åŠ¨æ‰€æœ‰æœåŠ¡
```

### æ‰‹åŠ¨è¯ä¹¦ç”Ÿæˆ (å¯é€‰)
```bash
# å¦‚éœ€é‡æ–°ç”Ÿæˆè¯ä¹¦
cd services/indexer
./scripts/generate-certs.sh
```

### 3. éªŒè¯éƒ¨ç½²
```bash
# æ£€æŸ¥OpenSearchå¥åº·çŠ¶æ€
curl http://localhost:9200/_cluster/health

# æ£€æŸ¥ç´¢å¼•æ¨¡æ¿
curl http://localhost:9200/_template/sysarmor-events-template
```

## ğŸ“Š ç´¢å¼•æ¨¡æ¿

### sysarmor-events-template
- **ç´¢å¼•æ¨¡å¼**: `sysarmor-events-*`, `sysarmor-alerts-*`
- **åˆ†ç‰‡é…ç½®**: 1ä¸ªä¸»åˆ†ç‰‡ï¼Œ0ä¸ªå‰¯æœ¬
- **åˆ·æ–°é—´éš”**: 5ç§’
- **å­—æ®µæ˜ å°„**: æ”¯æŒå®Œæ•´çš„å®‰å…¨äº‹ä»¶ç»“æ„

### ä¸»è¦å­—æ®µç±»å‹
- **æ—¶é—´å­—æ®µ**: `@timestamp`, `ingestion_timestamp`
- **å…³é”®å­—æ®µ**: `event_type`, `severity`, `host`
- **æ–‡æœ¬å­—æ®µ**: `message`, `cmdline` (æ”¯æŒå…¨æ–‡æœç´¢)
- **IPå­—æ®µ**: `src_ip`, `dst_ip` (æ”¯æŒIPèŒƒå›´æŸ¥è¯¢)
- **åœ°ç†å­—æ®µ**: `location` (æ”¯æŒåœ°ç†ä½ç½®æŸ¥è¯¢)

## ğŸ” ç›‘æ§æŒ‡æ ‡

- **é›†ç¾¤å¥åº·**: Green/Yellow/RedçŠ¶æ€
- **ç´¢å¼•æ•°é‡**: æ´»è·ƒç´¢å¼•ç»Ÿè®¡
- **è¿æ¥çŠ¶æ€**: OpenSearchè¿æ¥å¥åº·æ£€æŸ¥
- **æ¨¡æ¿çŠ¶æ€**: ç´¢å¼•æ¨¡æ¿åŠ è½½çŠ¶æ€

## ğŸš¨ æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

1. **OpenSearchå¯åŠ¨å¤±è´¥**
   - æ£€æŸ¥å†…å­˜é…ç½®: `OPENSEARCH_JAVA_OPTS`
   - éªŒè¯SSLè¯ä¹¦: ç¡®ä¿è¯ä¹¦æ–‡ä»¶å­˜åœ¨ä¸”æƒé™æ­£ç¡®

2. **ç´¢å¼•æœåŠ¡è¿æ¥å¤±è´¥**
   - æ£€æŸ¥ç½‘ç»œè¿æ¥: ç¡®ä¿å®¹å™¨é—´ç½‘ç»œé€šä¿¡æ­£å¸¸
   - éªŒè¯è®¤è¯ä¿¡æ¯: æ£€æŸ¥ç”¨æˆ·åå¯†ç é…ç½®

3. **ç´¢å¼•æ¨¡æ¿åŠ è½½å¤±è´¥**
   - æ£€æŸ¥æ¨¡æ¿æ–‡ä»¶: éªŒè¯JSONæ ¼å¼æ­£ç¡®æ€§
   - æŸ¥çœ‹æœåŠ¡æ—¥å¿—: `docker logs sysarmor-indexer-1`

### æ—¥å¿—æŸ¥çœ‹
```bash
# OpenSearchæ—¥å¿—
docker logs sysarmor-opensearch-1

# IndexeræœåŠ¡æ—¥å¿—
docker logs sysarmor-indexer-1
```

## ğŸ“ ç»´æŠ¤è¯´æ˜

- **ç´¢å¼•è½®è½¬**: æŒ‰æœˆè‡ªåŠ¨åˆ›å»ºæ–°ç´¢å¼•
- **è¯ä¹¦æ›´æ–°**: SSLè¯ä¹¦æœ‰æ•ˆæœŸ10å¹´ï¼Œéœ€å®šæœŸæ›´æ–°
- **æ¨¡æ¿æ›´æ–°**: ä¿®æ”¹æ¨¡æ¿åéœ€é‡å¯æœåŠ¡ç”Ÿæ•ˆ
- **æ•°æ®å¤‡ä»½**: å»ºè®®å®šæœŸå¤‡ä»½OpenSearchæ•°æ®å·
