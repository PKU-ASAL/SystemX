# SysArmor 威胁检测规则配置 - Falco 风格版本
# 使用 Falco 风格的条件字符串语法，支持列表和宏
# 
# 规则结构说明:
# - id: 规则唯一标识符
# - name: 规则名称
# - description: 规则描述
# - category: 威胁类别
# - severity: 严重程度 (low/medium/high/critical)
# - base_score: 基础风险评分 (0-100)
# - enabled: 是否启用规则
# - condition: Falco 风格条件字符串
# - frequency_threshold: 频率阈值 (可选)
# - time_window: 时间窗口/秒 (可选)
# - score_multiplier: 评分乘数 (可选)

version: "3.0"
metadata:
  name: "SysArmor Falco-Style Threat Detection Rules"
  description: "使用 Falco 风格条件字符串的威胁检测规则集"
  author: "SysArmor Team"
  created_at: "2025-10-13"
  updated_at: "2025-10-16"
  format: "falco"

# 全局设置
global_settings:
  engine_version: "3.0"
  default_severity: "medium"
  enable_frequency_detection: true
  default_time_window: 300

# ========================================
# 列表定义 - 可复用的值集合
# ========================================
lists:
  # 文件操作相关
  - list: file_open_syscalls
    items:
      - open
      - openat
      - openat2
  
  - list: file_create_syscalls
    items:
      - open
      - openat
      - openat2
      - creat
  
  - list: exec_syscalls
    items:
      - execve
      - execveat
  
  - list: dup_syscalls
    items:
      - dup
      - dup2
      - dup3
  
  - list: symlink_syscalls
    items:
      - symlink
      - symlinkat
  
  - list: module_syscalls
    items:
      - init_module
      - finit_module
  
  # Shell 程序列表
  - list: shell_binaries
    items:
      - sh
      - bash
      - zsh
      - dash
  
  # 网络服务进程
  - list: web_server_binaries
    items:
      - nginx
      - httpd
      - apache2
      - lighttpd
  
  - list: database_binaries
    items:
      - mysqld
      - postgres
      - postgresql
  
  - list: network_server_binaries
    items:
      - nginx
      - httpd
      - apache2
      - lighttpd
      - mysqld
      - postgres
  
  # 敏感文件列表
  - list: sensitive_files
    items:
      - /etc/shadow
      - /etc/passwd
      - /etc/sudoers
      - /root/.ssh/id_rsa
      - /root/.ssh/id_dsa
      - /root/.ssh/id_ecdsa
      - /root/.ssh/id_ed25519
  
  - list: ssh_config_files
    items:
      - /etc/ssh/sshd_config
      - /etc/ssh/ssh_config
  
  # 系统二进制目录
  - list: system_binary_dirs
    items:
      - /bin/
      - /sbin/
      - /usr/bin/
      - /usr/sbin/
  
  # 临时目录
  - list: temp_dirs
    items:
      - /tmp/
      - /var/tmp/
      - /dev/shm/
  
  # 系统用户 UID
  - list: system_user_uids
    items:
      - 1
      - 2
      - 65534
  
  # 可信系统进程
  - list: trusted_system_processes
    items:
      - sshd
      - login
      - su
      - sudo
      - passwd
      - systemd
      - ssh
      - scp
      - rsync
  
  # 网络工具
  - list: network_tools
    items:
      - nc
      - ncat
      - netcat
      - socat
  
  - list: network_scanners
    items:
      - nmap
      - masscan
      - zmap
      - hping
      - tcpdump
      - wireshark
  
  # 数据销毁工具
  - list: data_destruction_tools
    items:
      - shred
      - mkfs
      - mke2fs
      - dd
      - wipe
  
  # 搜索工具
  - list: search_tools
    items:
      - grep
      - egrep
      - fgrep
      - find
      - cat
  
  # 网络套接字族
  - list: internet_socket_families
    items:
      - AF_INET
      - AF_INET6
  
  # 日志目录和文件
  - list: log_files_keywords
    items:
      - /var/log/
      - syslog
      - auth.log
  
  # SetUID/SetGID 系统调用号
  - list: setuid_syscalls
    items:
      - "105"  # setuid
      - "106"  # setgid
      - "113"  # setreuid
      - "114"  # setregid
  
  # 文件权限修改系统调用
  - list: chmod_syscalls
    items:
      - "90"   # chmod
      - "91"   # fchmod
  
  # 进程注入相关系统调用
  - list: process_injection_syscalls
    items:
      - ptrace
      - process_vm_writev
      - process_vm_readv

# ========================================
# 宏定义 - 可复用的条件片段
# ========================================
macros:
  # 文件操作宏
  - macro: file_open
    condition: evt.type in (file_open_syscalls)
  
  - macro: file_create
    condition: evt.type in (file_create_syscalls)
  
  - macro: spawned_process
    condition: evt.type in (exec_syscalls)
  
  - macro: is_shell
    condition: proc.name in (shell_binaries)
  
  # 网络相关宏
  - macro: is_web_server
    condition: proc.name in (web_server_binaries) or proc.pname in (web_server_binaries)
  
  - macro: is_database
    condition: proc.name in (database_binaries) or proc.pname in (database_binaries)
  
  - macro: is_network_server
    condition: proc.name in (network_server_binaries) or proc.pname in (network_server_binaries) or proc.pcmdline contains "nginx"
  
  - macro: internet_socket_family
    condition: net.sockaddr.family in (internet_socket_families)
  
  # 进程身份宏
  - macro: is_system_user
    condition: proc.uid in (system_user_uids)
  
  - macro: is_trusted_process
    condition: proc.name in (trusted_system_processes)
  
  # 路径相关宏
  - macro: is_temp_dir
    condition: proc.exe startswith "/tmp/" or proc.exe startswith "/var/tmp/" or proc.exe startswith "/dev/shm/"
  
  - macro: is_system_binary_dir
    condition: proc.exe startswith "/usr/" or proc.exe startswith "/bin/" or proc.exe startswith "/sbin/"
  
  # 敏感操作宏
  - macro: sensitive_file_access
    condition: fd.name in (sensitive_files)
  
  - macro: log_file_access
    condition: fd.name startswith "/var/log/" or fd.name contains "syslog" or fd.name contains "auth.log"

# ========================================
# 威胁检测规则 - Falco 风格条件
# ========================================
rules:
  # ========== 文件访问威胁 ==========
  
  - id: "directory_traversal_attack"
    name: "目录遍历攻击检测"
    description: "检测通过目录遍历访问敏感文件的攻击行为"
    category: "file_access"
    severity: "high"
    base_score: 80
    enabled: true
    condition: file_open and fd.name contains "../" and fd.name contains "/etc/"
  
  - id: "sensitive_file_access"
    name: "敏感文件访问检测"
    description: "检测访问敏感系统文件的行为"
    category: "file_access"
    severity: "medium"
    base_score: 70
    enabled: true
    condition: file_open and sensitive_file_access and not is_trusted_process
  
  - id: "ssh_config_access"
    name: "SSH 配置文件访问"
    description: "检测对 SSH 配置文件的访问和修改"
    category: "sensitive_files"
    severity: "medium"
    base_score: 65
    enabled: true
    condition: file_open and fd.name in (ssh_config_files)
    frequency_threshold: 1
    time_window: 300
    score_multiplier: 1.1
  
  - id: "create_symlink_sensitive_files"
    name: "敏感文件符号链接创建"
    description: "检测在敏感文件上创建符号链接"
    category: "file_access"
    severity: "medium"
    base_score: 70
    enabled: true
    condition: evt.type in (symlink_syscalls) and evt.args contains "/etc/shadow"
  
  - id: "clear_log_activities"
    name: "日志访问或修改活动检测"
    description: "检测访问或修改系统日志的活动"
    category: "defense_evasion"
    severity: "medium"
    base_score: 75
    enabled: true
    condition: file_open and log_file_access
  
  - id: "root_directory_write"
    name: "根目录写入检测"
    description: "检测向根目录写入文件的行为"
    category: "persistence"
    severity: "high"
    base_score: 75
    enabled: true
    condition: file_create and fd.name startswith "/root/" and not is_trusted_process
  
  # ========== 进程执行威胁 ==========
  
  - id: "untrusted_shell_spawn"
    name: "不可信进程生成Shell"
    description: "检测非Shell应用程序异常生成Shell进程"
    category: "process_execution"
    severity: "high"
    base_score: 85
    enabled: true
    condition: spawned_process and is_shell and is_network_server
  
  - id: "system_user_activity"
    name: "系统用户异常活动"
    description: "检测系统服务账户的异常活动"
    category: "suspicious_activity"
    severity: "medium"
    base_score: 60
    enabled: true
    condition: spawned_process and is_system_user and is_shell
  
  - id: "memfd_execution"
    name: "内存文件执行检测"
    description: "检测可疑的内存文件执行"
    category: "suspicious_activity"
    severity: "critical"
    base_score: 95
    enabled: true
    condition: evt.type = "execve" and proc.exe contains "memfd"
  
  - id: "dev_shm_execution"
    name: "/dev/shm目录执行检测"
    description: "检测从/dev/shm目录执行程序"
    category: "suspicious_activity"
    severity: "high"
    base_score: 80
    enabled: true
    condition: spawned_process and is_temp_dir
  
  - id: "temp_executable_creation"
    name: "临时目录可执行文件创建"
    description: "检测在临时目录创建可执行文件"
    category: "persistence"
    severity: "high"
    base_score: 80
    enabled: true
    condition: spawned_process and is_temp_dir
  
  - id: "suspicious_binary_execution"
    name: "可疑二进制执行检测"
    description: "检测从非标准位置执行的二进制文件"
    category: "persistence"
    severity: "high"
    base_score: 85
    enabled: true
    condition: evt.type = "execve" and not is_system_binary_dir
  
  - id: "bulk_data_removal"
    name: "批量数据清除检测"
    description: "检测批量数据删除或覆盖行为"
    category: "suspicious_activity"
    severity: "high"
    base_score: 85
    enabled: true
    condition: spawned_process and proc.name in (data_destruction_tools)
  
  # ========== 网络威胁 ==========
  
  - id: "network_redirect_stdio"
    name: "网络重定向检测"
    description: "检测可疑的网络重定向行为"
    category: "network_activity"
    severity: "high"
    base_score: 85
    enabled: true
    condition: evt.type in (dup_syscalls) and internet_socket_family
  
  - id: "netcat_execution"
    name: "网络工具执行检测"
    description: "检测网络工具的执行"
    category: "network_activity"
    severity: "high"
    base_score: 85
    enabled: true
    condition: spawned_process and proc.name in (network_tools)
  
  - id: "suspicious_network_tool_execution"
    name: "可疑网络工具执行检测"
    description: "检测可疑网络工具的执行"
    category: "network_activity"
    severity: "medium"
    base_score: 70
    enabled: true
    condition: spawned_process and proc.name in (network_scanners)
  
  - id: "nonstandard_port_connection"
    name: "非标准端口网络连接检测"
    description: "检测连接到非标准端口的行为"
    category: "network_activity"
    severity: "medium"
    base_score: 65
    enabled: true
    condition: evt.type = "connect" and fd.name contains ":4444"
  
  - id: "packet_socket_created"
    name: "数据包套接字创建检测"
    description: "检测创建数据包套接字的行为"
    category: "network_activity"
    severity: "medium"
    base_score: 65
    enabled: true
    condition: evt.type = "socket" and evt.args contains "AF_PACKET"
  
  - id: "unusual_network_listen"
    name: "异常网络监听检测"
    description: "检测异常的网络监听行为"
    category: "network_activity"
    severity: "medium"
    base_score: 60
    enabled: true
    condition: evt.type = "listen" and not is_network_server
  
  # ========== 权限提升威胁 ==========
  
  - id: "kernel_module_injection"
    name: "内核模块注入检测"
    description: "检测内核模块加载行为"
    category: "privilege_escalation"
    severity: "critical"
    base_score: 95
    enabled: true
    condition: evt.type in (module_syscalls)
  
  - id: "ptrace_attach"
    name: "PTRACE进程附加检测"
    description: "检测使用PTRACE附加到进程的行为"
    category: "privilege_escalation"
    severity: "high"
    base_score: 80
    enabled: true
    condition: evt.type = "ptrace" and evt.args contains "PTRACE_ATTACH"
  
  - id: "process_injection_detection"
    name: "进程注入检测"
    description: "检测进程注入相关的系统调用"
    category: "privilege_escalation"
    severity: "high"
    base_score: 85
    enabled: true
    condition: evt.type in (process_injection_syscalls)
  
  - id: "release_agent_file_access"
    name: "Release Agent文件访问检测"
    description: "检测访问release_agent文件的行为"
    category: "privilege_escalation"
    severity: "critical"
    base_score: 95
    enabled: true
    condition: file_open and fd.name contains "release_agent"
  
  - id: "privilege_escalation_setuid"
    name: "SetUID/SetGID 权限提升"
    description: "检测 setuid、setgid、setreuid、setregid 系统调用"
    category: "privilege_escalation"
    severity: "critical"
    base_score: 90
    enabled: true
    condition: evt.type in (setuid_syscalls)
    frequency_threshold: 1
    time_window: 300
    score_multiplier: 1.8
  
  - id: "sudo_privilege_escalation"
    name: "可疑Sudo权限提升检测"
    description: "检测可疑的sudo权限提升行为，包括执行高风险命令"
    category: "privilege_escalation"
    severity: "medium"
    base_score: 70
    enabled: true
    condition: >
      spawned_process and 
      proc.name = "sudo" and 
      proc.exe = "/usr/bin/sudo" and 
      (proc.cmdline contains "sudo su" or 
       proc.cmdline contains "sudo bash" or 
       proc.cmdline contains "sudo sh" or 
       proc.cmdline regex "sudo.*(rm|mv|cp|chmod|chown|passwd|usermod|useradd|userdel).*" or 
       (proc.cmdline startswith "sudo" and not proc.cmdline contains "systemctl status"))
    time_window: 300
    score_multiplier: 1.2
  
  # ========== 系统配置威胁 ==========
  
  - id: "system_binary_modification"
    name: "系统二进制文件修改"
    description: "检测对系统二进制文件的写入或修改操作"
    category: "system_binaries"
    severity: "critical"
    base_score: 95
    enabled: true
    condition: >
      ((evt.type = "open" or evt.type = "openat") and 
       (fd.name startswith "/bin/" or 
        fd.name startswith "/sbin/" or 
        fd.name startswith "/usr/bin/" or 
        fd.name startswith "/usr/sbin/")) or 
      (evt.type in (chmod_syscalls) and 
       (fd.name startswith "/bin/" or 
        fd.name startswith "/sbin/" or 
        fd.name startswith "/usr/bin/" or 
        fd.name startswith "/usr/sbin/"))
    frequency_threshold: 1
    time_window: 300
    score_multiplier: 2.0
  
  - id: "crontab_modification"
    name: "Crontab 定时任务修改"
    description: "检测对 crontab 和定时任务的修改"
    category: "scheduled_tasks"
    severity: "medium"
    base_score: 65
    enabled: true
    condition: >
      fd.name = "/etc/crontab" or 
      fd.name startswith "/etc/cron.d/" or 
      fd.name startswith "/var/spool/cron/" or 
      proc.name = "crontab"
    frequency_threshold: 1
    time_window: 300
    score_multiplier: 1.2
  
  - id: "kernel_module_loading"
    name: "内核模块加载"
    description: "检测内核模块的加载，可能表示 rootkit 安装"
    category: "system_configuration"
    severity: "critical"
    base_score: 85
    enabled: true
    condition: proc.name in ("insmod", "modprobe", "rmmod")
    frequency_threshold: 1
    time_window: 300
    score_multiplier: 1.6
  
  - id: "service_manipulation"
    name: "系统服务操作"
    description: "检测系统服务的启动、停止或配置修改"
    category: "system_configuration"
    severity: "medium"
    base_score: 55
    enabled: true
    condition: >
      (proc.name contains "systemctl" and 
       (proc.cmdline contains "start " or 
        proc.cmdline contains "stop " or 
        proc.cmdline contains "restart " or 
        proc.cmdline contains "reload " or 
        proc.cmdline contains "enable " or 
        proc.cmdline contains "disable ")) or 
      (proc.name = "service" and 
       (proc.cmdline contains " start" or 
        proc.cmdline contains " stop" or 
        proc.cmdline contains " restart"))
    frequency_threshold: 1
    time_window: 300
    score_multiplier: 1.1
  
  - id: "permission_modification"
    name: "文件权限修改"
    description: "检测危险的文件权限修改"
    category: "file_manipulation"
    severity: "high"
    base_score: 75
    enabled: true
    condition: proc.name = "chmod" and (proc.cmdline contains "777" or proc.cmdline contains "755" or proc.cmdline contains "+x")
    frequency_threshold: 2
    time_window: 300
    score_multiplier: 1.3
  
  # ========== 凭证访问威胁 ==========
  
  - id: "search_private_keys_passwords"
    name: "搜索私钥密码活动"
    description: "检测搜索私钥或密码的活动"
    category: "credential_access"
    severity: "medium"
    base_score: 72
    enabled: true
    condition: spawned_process and proc.name in (search_tools) and proc.cmdline contains "password"
  
  - id: "find_aws_credentials"
    name: "AWS凭证查找检测"
    description: "检测搜索AWS凭证的活动"
    category: "credential_access"
    severity: "high"
    base_score: 82
    enabled: true
    condition: >
      spawned_process and 
      proc.name in (search_tools) and 
      (proc.cmdline contains "aws_access_key_id" or 
       proc.cmdline contains "aws_secret_access_key")
  
  # ========== 认证威胁 ==========
  
  - id: "pam_authentication_failure"
    name: "PAM 认证失败"
    description: "检测 PAM 认证失败事件"
    category: "authentication"
    severity: "low"
    base_score: 35
    enabled: true
    condition: evt.type = "USER_AUTH" and evt.args contains "res=failed"
    frequency_threshold: 5
    time_window: 300
    score_multiplier: 1.1
  
  # ========== 防御规避威胁 ==========
  
  - id: "ptrace_antidebug"
    name: "PTRACE反调试尝试检测"
    description: "检测PTRACE反调试技术的使用"
    category: "defense_evasion"
    severity: "medium"
    base_score: 70
    enabled: true
    condition: evt.type = "ptrace" and evt.args contains "PTRACE_TRACEME"
  
  - id: "file_deletion_dangerous"
    name: "危险文件删除操作"
    description: "检测危险的文件删除操作"
    category: "file_manipulation"
    severity: "critical"
    base_score: 88
    enabled: true
    condition: proc.name in ("rm", "shred", "wipe") and (proc.cmdline regex "rm\\s+.*-[rf]" or proc.cmdline contains "shred" or proc.cmdline contains "wipe")
    frequency_threshold: 1
    time_window: 300
    score_multiplier: 1.4
  
  # ========== 命令注入威胁 ==========
  
  - id: "command_injection_indicators"
    name: "命令注入指标检测"
    description: "检测可能的命令注入攻击指标"
    category: "command_injection"
    severity: "critical"
    base_score: 85
    enabled: true
    condition: >
      evt.type = "execve" and 
      (proc.cmdline contains "bash -c" or 
       proc.cmdline contains "bash -i" or
       proc.cmdline contains "sh -c" or 
       proc.cmdline contains "sh -i" or 
       proc.cmdline contains "python -c" or 
       proc.cmdline contains "perl -e" or 
       (proc.name in (network_tools) and proc.cmdline contains "-e"))
    frequency_threshold: 1
    time_window: 300
    score_multiplier: 1.5

# ========================================
# 规则组配置 - 基于威胁类型和攻击场景的规则分类
# ========================================
rule_groups:
  critical_threats:
    description: "关键威胁 - 需要立即响应"
    rules:
      - "memfd_execution"
      - "kernel_module_injection"
      - "kernel_module_loading"
      - "release_agent_file_access"
      - "system_binary_modification"
      - "privilege_escalation_setuid"
      - "command_injection_indicators"
      - "file_deletion_dangerous"

  privilege_escalation:
    description: "权限提升 - 检测各种权限提升攻击"
    rules:
      - "privilege_escalation_setuid"
      - "sudo_privilege_escalation"
      - "ptrace_attach"
      - "process_injection_detection"

  suspicious_activities:
    description: "可疑活动 - 异常行为和潜在威胁"
    rules:
      - "untrusted_shell_spawn"
      - "system_user_activity"
      - "dev_shm_execution"
      - "bulk_data_removal"
      - "suspicious_binary_execution"
      - "temp_executable_creation"

  file_access:
    description: "敏感文件访问 - 检测对关键文件的访问"
    rules:
      - "directory_traversal_attack"
      - "sensitive_file_access"
      - "ssh_config_access"
      - "create_symlink_sensitive_files"
      - "clear_log_activities"
      - "root_directory_write"

  network_monitoring:
    description: "网络监控 - 检测网络相关的可疑活动"
    rules:
      - "network_redirect_stdio"
      - "netcat_execution"
      - "nonstandard_port_connection"
      - "suspicious_network_tool_execution"
      - "unusual_network_listen"
      - "packet_socket_created"

  credential_access:
    description: "凭证访问 - 检测密码和凭证相关的攻击"
    rules:
      - "search_private_keys_passwords"
      - "find_aws_credentials"

  system_integrity:
    description: "系统完整性 - 检测系统配置和服务的修改"
    rules:
      - "service_manipulation"
      - "crontab_modification"
      - "permission_modification"

  authentication_monitoring:
    description: "认证监控 - 检测认证相关的异常"
    rules:
      - "pam_authentication_failure"

  defense_evasion:
    description: "防御规避 - 检测反调试和日志清除等规避技术"
    rules:
      - "ptrace_antidebug"
