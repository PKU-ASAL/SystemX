# SysArmor Processor - Makefile
# PyFlink å®æ—¶å¨èƒæ£€æµ‹å¤„ç†å™¨

.PHONY: help up down clean logs status submit-datastream submit-configurable list-jobs cancel-job setup

# é»˜è®¤ç›®æ ‡ - æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
default: help

#==============================================================================
# Flink é›†ç¾¤ç®¡ç†
#==============================================================================

# å¯åŠ¨ Flink é›†ç¾¤
up:
	@echo "ğŸš€ Starting SysArmor Flink Cluster..."
	docker compose up -d --build
	@echo "âœ… Flink cluster started!"
	@echo "ğŸŒ Web UI: http://localhost:8081"

# åœæ­¢ Flink é›†ç¾¤
down:
	@echo "ğŸ›‘ Stopping SysArmor Flink Cluster..."
	docker compose down
	@echo "âœ… Flink cluster stopped!"

# æ¸…ç† Flink é›†ç¾¤å’Œæ•°æ®
clean:
	@echo "ğŸ—‘ï¸  Cleaning up SysArmor Flink Cluster..."
	docker compose down -v
	docker system prune -f
	@echo "âœ… Cleanup completed!"

# æŸ¥çœ‹æ—¥å¿—
logs:
	@echo "ğŸ“‹ SysArmor Flink Logs:"
	docker compose logs -f

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
status:
	@echo "ğŸ“Š SysArmor Flink Status:"
	docker compose ps

#==============================================================================
# ä½œä¸šç®¡ç†
#==============================================================================

# æäº¤åŸºç¡€å¨èƒæ£€æµ‹ä½œä¸š (DataStream API)
submit-datastream:
	@echo "ğŸŒŠ Submitting DataStream API Threat Detection Job..."
	docker compose exec flink-jobmanager flink run -py /opt/flink/usr_jobs/job_rules_filter_datastream.py
	@echo "âœ… DataStream threat detection job submitted!"
	@echo "ğŸ”§ Using DataStream API for better error handling"
	@echo "ğŸ¯ Stateful consecutive sudo detection with memory"
	@echo "ğŸš¨ Enhanced debugging and logging capabilities"
	@echo "ğŸ–¨ï¸  All threats printed to console with 'THREAT_DETECTED'"
	@echo "ğŸŒ Monitor at: http://localhost:8081"

# æäº¤åŸºäºé…ç½®æ–‡ä»¶çš„å¨èƒæ£€æµ‹ä½œä¸š (æ¨è)
submit-configurable:
	@echo "âš™ï¸  Submitting Configurable Threat Detection Job..."
	docker compose exec flink-jobmanager flink run -py /opt/flink/usr_jobs/job_rules_configuration_datastream.py
	@echo "âœ… Configurable threat detection job submitted!"
	@echo "ğŸ”§ åŸºäº threat_detection_rules.yaml é…ç½®æ–‡ä»¶"
	@echo "ğŸ¯ åŠ¨æ€è§„åˆ™åŠ è½½å’Œçƒ­é‡è½½æ”¯æŒ"
	@echo "ğŸš¨ é¢‘ç‡åŸºç¡€å¨èƒæ£€æµ‹ä¸æ—¶é—´çª—å£"
	@echo "ğŸ“‹ çµæ´»æ¨¡å¼åŒ¹é… (å…³é”®è¯ + æ­£åˆ™ + æ¡ä»¶)"
	@echo "ğŸšï¸  å¯é…ç½®é£é™©è¯„åˆ†å’Œä¸¥é‡ç¨‹åº¦"
	@echo "ğŸ“Š è§„åˆ™åˆ†ç»„å’Œåˆ†ç±»æ”¯æŒ"
	@echo "ğŸ–¨ï¸  All threats printed with 'CONFIG_THREAT_DETECTED' prefix"
	@echo "ğŸŒ Monitor at: http://localhost:8081"

# æäº¤ç®€å•æ§åˆ¶å°æµ‹è¯•ä½œä¸š (ç”¨äºåŸºæœ¬åŠŸèƒ½éªŒè¯)
submit-console-test:
	@echo "ğŸ–¥ï¸  Submitting Simple Console Test Job..."
	docker compose exec flink-jobmanager flink run -py /opt/flink/usr_jobs/job_simple_console_test.py
	@echo "âœ… Simple console test job submitted!"
	@echo "ğŸ” è¯»å–æŒ‡å®š topic prefix çš„æ•°æ®å¹¶è¾“å‡ºåˆ°æ§åˆ¶å°"
	@echo "ğŸ“‹ é»˜è®¤ç›‘å¬ topics: sysarmor-events-test, sysarmor-agentless-*"
	@echo "ğŸ¯ å•å¹¶è¡Œåº¦ï¼Œä¾¿äºè§‚å¯Ÿè¾“å‡ºé¡ºåº"
	@echo "ğŸ“ æ¶ˆæ¯æ ¼å¼: 'ğŸ” MESSAGE #N | Time | Host | Collector | Content'"
	@echo "ğŸ–¨ï¸  All messages printed to TaskManager console"
	@echo "ğŸŒ Monitor at: http://localhost:8081"
	@echo "ğŸ“Š Check TaskManager logs: docker logs processor-taskmanager"

# åˆ—å‡ºæ‰€æœ‰ä½œä¸š
list-jobs:
	@echo "ğŸ“‹ Active Flink Jobs:"
	docker compose exec flink-jobmanager flink list

# å–æ¶ˆä½œä¸š (éœ€è¦æŒ‡å®š JOB_ID)
cancel-job:
	@if [ -z "$(JOB_ID)" ]; then \
		echo "âŒ Please specify JOB_ID: make cancel-job JOB_ID=your_job_id"; \
		exit 1; \
	fi
	@echo " Cancelling job $(JOB_ID)..."
	docker compose exec flink-jobmanager flink cancel $(JOB_ID)

#==============================================================================
# å¼€å‘å’Œæµ‹è¯•
#==============================================================================

# è®¾ç½®å¼€å‘ç¯å¢ƒ
setup:
	@echo "âš™ï¸  Setting up SysArmor Processor..."
	@mkdir -p jobs
	@echo "âœ… Setup completed!"
	@echo "ğŸ“ Please configure environment variables in .env"

# å¸®åŠ©ä¿¡æ¯
help:
	@echo "ğŸš€ SysArmor Processor - PyFlink å®æ—¶å¨èƒæ£€æµ‹å¤„ç†å™¨"
	@echo "=================================================="
	@echo ""
	@echo "ğŸ› ï¸  Cluster Management:"
	@echo "  make up             - å¯åŠ¨ Flink é›†ç¾¤"
	@echo "  make down           - åœæ­¢ Flink é›†ç¾¤"
	@echo "  make clean          - æ¸…ç†é›†ç¾¤å’Œæ•°æ®"
	@echo "  make status         - æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
	@echo "  make logs           - æŸ¥çœ‹æ‰€æœ‰æ—¥å¿—"
	@echo ""
	@echo "ğŸ“‹ Job Management:"
	@echo "  make submit-console-test - æäº¤ç®€å•æ§åˆ¶å°æµ‹è¯•ä½œä¸š (åŸºæœ¬åŠŸèƒ½éªŒè¯)"
	@echo "  make submit-datastream   - æäº¤åŸºç¡€å¨èƒæ£€æµ‹ä½œä¸š (DataStream API)"
	@echo "  make submit-configurable - æäº¤åŸºäºé…ç½®æ–‡ä»¶çš„å¨èƒæ£€æµ‹ä½œä¸š (æ¨è)"
	@echo "  make list-jobs           - åˆ—å‡ºæ‰€æœ‰ä½œä¸š"
	@echo "  make cancel-job JOB_ID=xxx - å–æ¶ˆæŒ‡å®šä½œä¸š"
	@echo ""
	@echo "âš™ï¸  Development:"
	@echo "  make setup          - åˆå§‹åŒ–å¼€å‘ç¯å¢ƒ"
	@echo ""
	@echo "ğŸŒ Web Interfaces:"
	@echo "  Flink Web UI:       http://localhost:8081"
	@echo ""
	@echo "ğŸ“– Quick Start:"
	@echo "  1. make setup            # åˆå§‹åŒ–ç¯å¢ƒ"
	@echo "  2. make up               # å¯åŠ¨é›†ç¾¤"
	@echo "  3. make submit-console-test # æäº¤ç®€å•æµ‹è¯•ä½œä¸š (éªŒè¯åŸºæœ¬åŠŸèƒ½)"
	@echo "  4. make status           # æ£€æŸ¥çŠ¶æ€"
	@echo "  5. docker logs processor-taskmanager # æŸ¥çœ‹æ§åˆ¶å°è¾“å‡º"
	@echo ""
	@echo "ğŸ’¡ Available Jobs:"
	@echo "   - job_simple_console_test.py           # ç®€å•æ§åˆ¶å°æµ‹è¯• (æ¨èå…ˆæµ‹è¯•)"
	@echo "   - job_rules_filter_datastream.py       # åŸºç¡€å¨èƒæ£€æµ‹"
	@echo "   - job_rules_configuration_datastream.py # é…ç½®åŒ–å¨èƒæ£€æµ‹"
