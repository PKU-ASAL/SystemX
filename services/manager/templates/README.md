# SysArmor Manager Templates

这个目录包含了 SysArmor Manager 用于生成各种配置文件的模板。

## Agentless 模板

### 最新更新 (2025-08-08)

我们已经将 agentless 模板更新为**优化版本**，大幅减少了 auditd 数据量，同时保持对高价值安全事件的监控能力。

#### 主要改进

1. **数据量减少 80-90%**: 通过智能过滤和排除规则，大幅减少不必要的事件
2. **专注高价值事件**: 只监控真正重要的安全威胁
3. **性能优化**: 减少系统资源使用，提高稳定性
4. **智能过滤**: 在 rsyslog 层面就过滤掉不重要的事件

#### 文件说明

- `setup-terminal.sh.tmpl`: 主要的安装脚本模板
- `audit-rules.tmpl`: 优化的 auditd 规则模板
- `uninstall-terminal.sh.tmpl`: 卸载脚本模板

### 优化特性

#### A. Auditd 规则优化
- **速率限制**: 每秒最多 500 条消息
- **缓冲区优化**: 从 8192 减少到 4096
- **专注监控**: 只监控可疑路径执行、权限提升、敏感文件访问
- **排除规则**: 排除常见系统进程（apt, dpkg, systemctl 等）

#### B. Rsyslog 过滤优化
- **事件类型过滤**: 只转发重要的 audit 事件类型
- **关键字过滤**: 基于 key 值进行智能过滤
- **路径过滤**: 只关注敏感路径的事件
- **队列优化**: 减少内存和磁盘使用

#### C. 系统性能优化
- **日志轮转**: 50MB 最大文件大小
- **磁盘使用**: 20MB 最大队列磁盘空间
- **内存优化**: 1000 队列大小限制
- **网络优化**: 单线程处理，减少开销

### 监控范围

#### 高价值安全事件
1. **可疑进程执行**: `/tmp/`, `/dev/shm/`, `/var/tmp/` 路径
2. **权限提升**: setuid, setgid, setreuid, setregid 系统调用
3. **敏感文件访问**: `/etc/passwd`, `/etc/shadow`, `/etc/sudoers`
4. **系统文件修改**: `/bin/`, `/sbin/`, `/usr/bin/`, `/usr/sbin/`
5. **网络连接**: socket, connect 系统调用
6. **用户认证**: 认证日志文件变化
7. **定时任务**: crontab 相关文件变化

#### 排除的噪音事件
- 常见系统管理工具: dpkg, apt, systemctl
- 基础命令工具: ps, ls, cat, grep
- 系统用户活动: daemon, nobody 等

### 预期效果

| 指标 | 原配置 | 优化配置 | 改进 |
|------|--------|----------|------|
| 日均事件数 | 100,000+ | 10,000-20,000 | 80-90% 减少 |
| 缓冲区大小 | 8192 | 4096 | 50% 减少 |
| 队列大小 | 5000 | 1000 | 80% 减少 |
| 磁盘使用 | 50MB | 20MB | 60% 减少 |
| 日志文件 | 无限制 | 50MB | 大幅优化 |

### 使用方法

模板使用 Go 的 `text/template` 语法，支持以下变量：

- `{{.CollectorID}}`: 收集器 ID
- `{{.WorkerAddress}}`: Worker 完整地址
- `{{.WorkerHost}}`: Worker 主机地址
- `{{.WorkerPort}}`: Worker 端口
- `{{.Hostname}}`: 目标主机名
- `{{.OSType}}`: 操作系统类型
- `{{.OSVersion}}`: 操作系统版本
- `{{.GeneratedAt}}`: 生成时间
- `{{.AuditRules}}`: Audit 规则内容

### 兼容性

- **操作系统**: Ubuntu 18.04+, CentOS 7+, RHEL 7+
- **Rsyslog**: 8.2112.0+
- **Auditd**: 2.8.0+
- **架构**: x86_64, ARM64

### 故障排除

如果遇到数据量仍然过大的问题，可以考虑：

1. **进一步减少监控范围**: 注释掉不需要的规则
2. **降低速率限制**: 将 `-r 500` 改为 `-r 100`
3. **增加排除规则**: 添加更多常见进程到排除列表
4. **使用最小化版本**: 考虑使用 `setup-terminal-minimal.sh` 版本

### 更新历史

- **2025-08-08**: 更新为优化版本，大幅减少数据量
- **2025-08-07**: 初始版本，基础 auditd 配置

### 相关文档

- [SysArmor Manager API 文档](../docs/swagger.yaml)
- [Kafka Topics 增强文档](../docs/kafka-topics-enhancement.md)
- [部署指南](../README.md)
