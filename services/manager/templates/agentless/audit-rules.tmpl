# SysArmor audit rules for security monitoring (优化版本)
# 专注高价值安全事件，大幅减少数据量
# Generated for collector: {{.CollectorID}}
# Auto-generated - DO NOT EDIT MANUALLY

# 删除所有现有规则
-D

# 设置缓冲区大小 (减小以降低内存使用)
-b 4096

# 设置失败模式 (0=silent, 1=printk, 2=panic)
-f 1

# 设置速率限制 (每秒最多500条消息，防止日志洪水)
-r 500

# === 高价值安全事件监控 ===

# 1. 进程执行监控 (只监控特定可疑路径和SUID程序)
-a always,exit -F arch=b64 -S execve -F exe=/tmp/* -k suspicious_activity
-a always,exit -F arch=b64 -S execve -F exe=/dev/shm/* -k suspicious_activity
-a always,exit -F arch=b64 -S execve -F exe=/var/tmp/* -k suspicious_activity
-a always,exit -F arch=b32 -S execve -F exe=/tmp/* -k suspicious_activity
-a always,exit -F arch=b32 -S execve -F exe=/dev/shm/* -k suspicious_activity
-a always,exit -F arch=b32 -S execve -F exe=/var/tmp/* -k suspicious_activity

# 2. 权限提升监控
-a always,exit -F arch=b64 -S setuid -S setgid -S setreuid -S setregid -k privilege_escalation
-a always,exit -F arch=b32 -S setuid -S setgid -S setreuid -S setregid -k privilege_escalation

# 3. 敏感文件访问监控 (只监控写入操作)
-w /etc/passwd -p wa -k sensitive_files
-w /etc/shadow -p wa -k sensitive_files
-w /etc/sudoers -p wa -k sensitive_files
-w /etc/sudoers.d/ -p wa -k sensitive_files
-w /etc/ssh/sshd_config -p wa -k sensitive_files

# 4. 系统关键目录监控 (只监控写入和属性变更)
-w /bin/ -p wa -k system_binaries
-w /sbin/ -p wa -k system_binaries
-w /usr/bin/ -p wa -k system_binaries
-w /usr/sbin/ -p wa -k system_binaries

# 5. 网络连接监控 (只监控特定端口和协议)
-a always,exit -F arch=b64 -S socket -F a0=2 -k network_connections
-a always,exit -F arch=b64 -S connect -F a0=2 -k network_connections
-a always,exit -F arch=b32 -S socket -F a0=2 -k network_connections
-a always,exit -F arch=b32 -S connect -F a0=2 -k network_connections

# 6. 用户认证和会话监控
-w /var/log/auth.log -p wa -k authentication
-w /var/log/secure -p wa -k authentication

# 7. 定时任务监控
-w /etc/crontab -p wa -k scheduled_tasks
-w /etc/cron.d/ -p wa -k scheduled_tasks
-w /var/spool/cron/ -p wa -k scheduled_tasks

# === 排除规则 - 减少噪音 ===

# 排除常见的系统进程，减少数据量
-a never,exit -F arch=b64 -S execve -F exe=/usr/bin/dpkg
-a never,exit -F arch=b64 -S execve -F exe=/usr/bin/apt
-a never,exit -F arch=b64 -S execve -F exe=/usr/bin/apt-get
-a never,exit -F arch=b64 -S execve -F exe=/bin/systemctl
-a never,exit -F arch=b64 -S execve -F exe=/usr/bin/systemctl
-a never,exit -F arch=b64 -S execve -F exe=/bin/ps
-a never,exit -F arch=b64 -S execve -F exe=/usr/bin/ps
-a never,exit -F arch=b64 -S execve -F exe=/bin/ls
-a never,exit -F arch=b64 -S execve -F exe=/usr/bin/ls

# 排除特定用户的活动 (如果有系统用户需要排除)
# -a never,user -F uid=daemon
# -a never,user -F uid=nobody

# 注意: 移除了 -e 2 (不可变模式) 以便于干净卸载
# 规则在系统重启后仍然有效，但可以在运行时修改和删除
