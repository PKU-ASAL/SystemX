FROM node:18-alpine AS base

# Install dependencies only when needed
FROM base AS deps
# Check https://github.com/nodejs/docker-node/tree/b4117f9333da4138b03a546ec926ef50a31506c3#nodealpine to understand why libc6-compat might be needed.
RUN apk add --no-cache libc6-compat
WORKDIR /app

# Install dependencies based on the preferred package manager
COPY package.json pnpm-lock.yaml* ./
# Configure Chinese mirrors for better network connectivity
RUN npm config set registry https://registry.npmmirror.com/ && \
    corepack enable pnpm && \
    pnpm config set registry https://registry.npmmirror.com/ && \
    pnpm i --no-frozen-lockfile

# Development image with hot reload support
FROM base AS development
WORKDIR /app

# Copy node_modules from deps stage
COPY --from=deps /app/node_modules ./node_modules

# Build-time environment variables for UI container internal access
ARG UI_MANAGER_HOST=sysarmor-manager-1
ARG UI_MANAGER_PORT=8080
ENV UI_MANAGER_HOST=$UI_MANAGER_HOST
ENV UI_MANAGER_PORT=$UI_MANAGER_PORT

# Build-time environment variables for external APIs
ARG THREAT_API_BASE_URL=http://110.40.136.112:1334/api
ARG THREAT_API_ENABLED=true
ENV NEXT_PUBLIC_THREAT_API_BASE_URL=$THREAT_API_BASE_URL
ENV NEXT_PUBLIC_THREAT_API_ENABLED=$THREAT_API_ENABLED

# Development environment settings
ENV NODE_ENV=development
ENV NEXT_TELEMETRY_DISABLED=1

# Enable hot reload and file watching
ENV WATCHPACK_POLLING=true
ENV CHOKIDAR_USEPOLLING=true

# Copy package.json for dependency reference
COPY package.json pnpm-lock.yaml* ./

# Copy configuration files
COPY next.config.ts ./
COPY postcss.config.mjs ./
COPY tsconfig.json ./
COPY components.json ./

# Create directories that will be mounted
RUN mkdir -p app components lib hooks types utils public

EXPOSE 3000

ENV PORT=3000
ENV HOSTNAME="0.0.0.0"

# Use development server with hot reload
CMD ["sh", "-c", "corepack enable pnpm && pnpm dev"]
